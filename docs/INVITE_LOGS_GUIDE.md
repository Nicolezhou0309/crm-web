# é‚€è¯·åŠŸèƒ½æ—¥å¿—æŸ¥çœ‹æŒ‡å—

## ğŸ” é—®é¢˜æè¿°

é‚€è¯·ç”¨æˆ·æ—¶å‡ºç°é”™è¯¯ï¼š`Edge Function returned a non-2xx status code`

## ğŸ“Š æ—¥å¿—å¢å¼º

å·²ä¸º `invite-user` å‡½æ•°æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š

### 1. å‡½æ•°æ‰§è¡Œæ—¥å¿—
- âœ… å‡½æ•°å¼€å§‹æ‰§è¡Œæ—¶é—´
- âœ… è¯·æ±‚URLå’Œæ–¹æ³•
- âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥
- âœ… è¯·æ±‚å‚æ•°éªŒè¯

### 2. æƒé™æ£€æŸ¥æ—¥å¿—
- âœ… ç”¨æˆ·èº«ä»½éªŒè¯
- âœ… ç»„ç»‡æƒé™éªŒè¯
- âœ… æƒé™æ£€æŸ¥ç»“æœ

### 3. æ•°æ®åº“æ“ä½œæ—¥å¿—
- âœ… ç»„ç»‡ä¿¡æ¯æŸ¥è¯¢
- âœ… ç”¨æˆ·æ¡£æ¡ˆæ£€æŸ¥
- âœ… æ•°æ®åº“æ“ä½œç»“æœ

### 4. é‚®ä»¶å‘é€æ—¥å¿—
- âœ… Supabaseé‚€è¯·é…ç½®
- âœ… Resendé‚®ä»¶é…ç½®
- âœ… é‚®ä»¶å‘é€çŠ¶æ€
- âœ… APIå“åº”è¯¦æƒ…

### 5. é”™è¯¯å¤„ç†æ—¥å¿—
- âœ… è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… é”™è¯¯å †æ ˆè·Ÿè¸ª
- âœ… é”™è¯¯åˆ†ç±»åˆ†æ

## ğŸ› ï¸ æŸ¥çœ‹æ—¥å¿—çš„æ–¹æ³•

### æ–¹æ³•1ï¼šSupabaseæ§åˆ¶å°ï¼ˆæ¨èï¼‰

1. **è®¿é—®Supabaseæ§åˆ¶å°**
   - ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
   - è¿›å…¥é¡¹ç›® `wteqgprgiylmxzszcnws`

2. **æŸ¥çœ‹Edge Functionsæ—¥å¿—**
   - ç‚¹å‡»å·¦ä¾§èœå• "Edge Functions"
   - æ‰¾åˆ° `invite-user` å‡½æ•°
   - ç‚¹å‡» "Logs" æ ‡ç­¾é¡µ

3. **å®æ—¶ç›‘æ§æ—¥å¿—**
   - æ—¥å¿—ä¼šå®æ—¶æ›´æ–°
   - å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹
   - åŒ…å«æ‰€æœ‰é”™è¯¯ä¿¡æ¯

### æ–¹æ³•2ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

è¿è¡Œæµ‹è¯•è„šæœ¬æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š

```bash
node test_invite_with_logs.js
```

### æ–¹æ³•3ï¼šç›´æ¥è°ƒç”¨å‡½æ•°

ä½¿ç”¨curlå‘½ä»¤ç›´æ¥è°ƒç”¨å‡½æ•°ï¼š

```bash
curl -X POST http://47.123.26.25:8000/functions/v1/invite-user \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","name":"Test User","organizationId":"your-org-id"}'
```

## ğŸ“‹ æ—¥å¿—åˆ†ææ­¥éª¤

### 1. æ£€æŸ¥å‡½æ•°å¯åŠ¨æ—¥å¿—
```
ğŸš€ ===== é‚€è¯·ç”¨æˆ·å‡½æ•°å¼€å§‹æ‰§è¡Œ =====
ğŸ“… æ‰§è¡Œæ—¶é—´: 2024-01-20T10:30:00.000Z
ğŸŒ è¯·æ±‚URL: http://47.123.26.25:8000/functions/v1/invite-user
ğŸ“‹ è¯·æ±‚æ–¹æ³•: POST
```

### 2. æ£€æŸ¥ç¯å¢ƒå˜é‡
```
ğŸ” ç¯å¢ƒå˜é‡æ£€æŸ¥: {
  FRONTEND_URL: "https://crm-web-ncioles-projects.vercel.app",
  hasSupabaseUrl: true,
  hasAnonKey: true,
  hasServiceKey: true,
  hasResendKey: true
}
```

### 3. æ£€æŸ¥è¯·æ±‚å‚æ•°
```
ğŸ“‹ è¯·æ±‚ä½“: {
  email: "test@example.com",
  name: "Test User",
  organizationId: "org-id"
}
âœ… è¯·æ±‚å‚æ•°éªŒè¯é€šè¿‡
```

### 4. æ£€æŸ¥ç”¨æˆ·è®¤è¯
```
ğŸ” ç”¨æˆ·éªŒè¯ç»“æœ: {
  user: "user-id",
  email: "user@example.com",
  error: null
}
âœ… ç”¨æˆ·å·²æˆæƒ
```

### 5. æ£€æŸ¥æƒé™éªŒè¯
```
ğŸ” å¼€å§‹æ£€æŸ¥æƒé™: { orgId: "org-id", userId: "user-id" }
âœ… ç»„ç»‡ä¿¡æ¯: { id: "org-id", admin: "user-id", name: "ç»„ç»‡åç§°" }
âœ… ç”¨æˆ·æ˜¯ç›´æ¥ç®¡ç†å‘˜
ğŸ” æƒé™æ£€æŸ¥ç»“æœ: true
```

### 6. æ£€æŸ¥é‚®ä»¶å‘é€
```
ğŸ“§ å¼€å§‹å‘é€Supabaseé‚€è¯·é‚®ä»¶...
ğŸ”§ Supabaseé‚€è¯·é…ç½®: {
  hasSupabaseUrl: true,
  hasServiceKey: true,
  frontendUrl: "https://crm-web-ncioles-projects.vercel.app"
}
âœ… Supabaseé‚€è¯·æˆåŠŸ
```

## ğŸš¨ å¸¸è§é”™è¯¯åˆ†æ

### 500é”™è¯¯ - å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
```
âŒ é‚€è¯·ç”¨æˆ·å¼‚å¸¸: Error: é”™è¯¯ä¿¡æ¯
âŒ é”™è¯¯å †æ ˆ: Error stack trace
```

**å¯èƒ½åŸå› ï¼š**
- ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
- æ•°æ®åº“è¿æ¥å¤±è´¥
- æƒé™æ£€æŸ¥å¼‚å¸¸
- é‚®ä»¶å‘é€å¤±è´¥

### 401é”™è¯¯ - æœªæˆæƒ
```
âŒ ç”¨æˆ·æœªæˆæƒ: é”™è¯¯ä¿¡æ¯
```

**å¯èƒ½åŸå› ï¼š**
- ç”¨æˆ·æœªç™»å½•
- JWT tokenè¿‡æœŸ
- Authorization headerç¼ºå¤±

### 403é”™è¯¯ - ç¦æ­¢è®¿é—®
```
âŒ æ— æƒç®¡ç†æ­¤ç»„ç»‡
```

**å¯èƒ½åŸå› ï¼š**
- ç”¨æˆ·ä¸æ˜¯ç»„ç»‡ç®¡ç†å‘˜
- ç»„ç»‡æƒé™é…ç½®é”™è¯¯

### 400é”™è¯¯ - è¯·æ±‚é”™è¯¯
```
âŒ ç¼ºå°‘é‚®ç®±åœ°å€
âŒ ç¼ºå°‘éƒ¨é—¨ID
```

**å¯èƒ½åŸå› ï¼š**
- è¯·æ±‚å‚æ•°ä¸å®Œæ•´
- å‚æ•°æ ¼å¼é”™è¯¯

## ğŸ”§ æ•…éšœæ’é™¤æ­¥éª¤

### 1. ç«‹å³æ£€æŸ¥
1. **æŸ¥çœ‹Supabaseæ§åˆ¶å°æ—¥å¿—**
2. **è¿è¡Œæµ‹è¯•è„šæœ¬**
3. **æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®**

### 2. ç¯å¢ƒå˜é‡æ£€æŸ¥
```bash
supabase secrets list
```

ç¡®ä¿ä»¥ä¸‹å˜é‡å·²é…ç½®ï¼š
- `FRONTEND_URL`
- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `RESEND_API_KEY`

### 3. é‡æ–°éƒ¨ç½²å‡½æ•°
```bash
supabase functions deploy invite-user
```

### 4. æµ‹è¯•å‡½æ•°
```bash
node test_invite_with_logs.js
```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼š

1. **æ”¶é›†æ—¥å¿—ä¿¡æ¯**
   - å¤åˆ¶Supabaseæ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—
   - è®°å½•é”™è¯¯å‘ç”Ÿçš„æ—¶é—´
   - ä¿å­˜æµ‹è¯•è„šæœ¬çš„è¾“å‡º

2. **æ£€æŸ¥é…ç½®**
   - éªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®
   - ç¡®è®¤ç”¨æˆ·æƒé™
   - æ£€æŸ¥ç»„ç»‡é…ç½®

3. **è”ç³»æ”¯æŒ**
   - æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - è¯´æ˜å¤ç°æ­¥éª¤
   - é™„ä¸Šç›¸å…³é…ç½®ä¿¡æ¯

## ğŸ¯ é¢„æœŸç»“æœ

æˆåŠŸæ‰§è¡Œååº”è¯¥çœ‹åˆ°ï¼š

```
âœ… é‚€è¯·æˆåŠŸ: {
  success: true,
  method: "supabase_invite",
  data: {
    email_id: "email-id",
    invite_sent_at: "2024-01-20T10:30:00.000Z",
    redirect_url: "https://crm-web-ncioles-projects.vercel.app/set-password"
  }
}
```

---

**æ›´æ–°æ—¶é—´**: 2024å¹´1æœˆ
**ç‰ˆæœ¬**: v2.0.0
**çŠ¶æ€**: âœ… å·²å¢å¼ºæ—¥å¿—åŠŸèƒ½ 