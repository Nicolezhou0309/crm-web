# 数据分析功能使用指南

## 📊 功能概述

数据分析功能是一个强大的商业智能(BI)工具，支持对leads、followups、showings、deals四张表的数据进行透视分析。用户可以：

- **数据拼接**：自动关联四张表的数据
- **透视表分析**：支持多维度数据透视
- **可视化展示**：表格形式展示分析结果
- **配置保存**：保存常用的透视表配置
- **数据导出**：支持Excel和CSV格式导出

## 🚀 快速开始

### 1. 部署数据库表

```bash
# 在项目根目录运行
chmod +x deploy-bi-tables.sh
./deploy-bi-tables.sh
```

### 2. 访问数据分析页面

启动开发服务器后，访问：`http://localhost:5173/data-analysis`

## 📋 功能详解

### 1. 数据源管理

#### 支持的字段
- **Leads表字段**：线索编号、手机号、微信号、来源、线索类型、线索状态、区域、位置、预算、创建时间
- **Followups表字段**：跟进阶段、客户画像、工作地点、用户预算、用户评级、主要类别、子类别、跟进结果、预约社区、面试销售
- **Showings表字段**：看房结果、社区、预算、租期、带看销售、实际销售
- **Deals表字段**：签约日期、合同编号、房间号、渠道、面试销售

#### 字段分类
- **维度字段**：用于行、列维度的分类字段
- **度量字段**：用于计算聚合值的数值字段

### 2. 透视表配置

#### 配置步骤
1. **选择行维度**：点击维度字段添加到行维度
2. **选择列维度**：点击维度字段添加到列维度
3. **选择值字段**：点击度量字段添加到值字段
4. **设置聚合方式**：支持求和、计数、平均值、最大值、最小值
5. **执行透视表**：点击"执行透视表"按钮

#### 支持的聚合方式
- **sum**：求和
- **count**：计数
- **avg**：平均值
- **max**：最大值
- **min**：最小值

### 3. 筛选条件

#### 时间筛选
- 支持日期范围选择
- 自动应用到所有相关表的时间字段

#### 业务筛选
- **来源**：抖音、小红书、微信、其他
- **线索类型**：长租、短租、其他
- **跟进阶段**：待接收、已接收、跟进中、已成交
- **看房结果**：直签、预定、意向金、考虑中、已流失
- **社区**：支持多选社区筛选

### 4. 数据统计

#### 实时统计
- **总记录数**：当前筛选条件下的总记录数
- **已成交数**：跟进阶段为"已成交"的记录数
- **转化率**：已成交数/总记录数
- **平均预算**：用户预算的平均值

### 5. 配置管理

#### 保存配置
1. 配置好透视表后，点击"新建透视表"
2. 输入配置名称和描述
3. 点击"保存"按钮

#### 使用保存的配置
1. 切换到"保存的配置"标签页
2. 点击"使用"按钮加载配置
3. 自动切换到透视表页面并执行

#### 管理配置
- **编辑**：修改配置名称和描述
- **删除**：删除不需要的配置
- **使用**：快速应用配置

## 🎯 使用场景

### 1. 销售业绩分析
**配置示例**：
- 行维度：面试销售
- 列维度：跟进阶段
- 值字段：计数

**分析内容**：
- 各销售人员的线索分配情况
- 各阶段的转化情况
- 销售业绩排名

### 2. 渠道效果分析
**配置示例**：
- 行维度：来源
- 列维度：看房结果
- 值字段：计数

**分析内容**：
- 各渠道的线索质量
- 渠道转化率对比
- 渠道投入产出比

### 3. 社区热度分析
**配置示例**：
- 行维度：社区
- 列维度：看房结果
- 值字段：计数

**分析内容**：
- 各社区的受欢迎程度
- 社区成交情况
- 社区投资价值

### 4. 时间趋势分析
**配置示例**：
- 行维度：创建时间（按月）
- 列维度：跟进阶段
- 值字段：计数

**分析内容**：
- 线索获取趋势
- 转化率变化
- 业务增长情况

## 🔧 技术特性

### 1. 数据拼接
- 基于现有的`filter_followups`函数
- 自动关联四张表的数据
- 支持复杂的筛选条件

### 2. 透视表引擎
- 前端JavaScript计算引擎
- 支持多维度分组
- 实时计算聚合值

### 3. 权限控制
- 基于RLS的行级安全
- 用户只能访问自己的配置
- 支持公开配置共享

### 4. 性能优化
- 数据分页加载
- 前端缓存机制
- 响应式设计

## 📈 扩展功能

### 1. 图表可视化
- 柱状图展示
- 饼图分析
- 折线图趋势

### 2. 高级计算
- 百分比计算
- 环比分析
- 自定义公式

### 3. 数据导出
- Excel格式导出
- CSV格式导出
- 自定义导出模板

### 4. 报表调度
- 定时生成报表
- 邮件推送
- 报表订阅

## 🛠️ 故障排除

### 1. 数据加载失败
**问题**：点击"加载数据"后没有数据
**解决**：
- 检查筛选条件是否过于严格
- 确认数据库连接正常
- 查看浏览器控制台错误信息

### 2. 透视表计算错误
**问题**：透视表结果异常
**解决**：
- 检查字段类型是否正确
- 确认聚合方式是否合适
- 验证数据格式是否规范

### 3. 配置保存失败
**问题**：无法保存透视表配置
**解决**：
- 检查用户登录状态
- 确认数据库权限
- 验证配置格式是否正确

## 📞 技术支持

如果您在使用过程中遇到问题，可以：

1. 查看浏览器控制台错误信息
2. 检查数据库连接状态
3. 联系技术支持团队

---

**版本**：v1.0.0  
**更新日期**：2025年1月  
**维护团队**：CRM开发团队 