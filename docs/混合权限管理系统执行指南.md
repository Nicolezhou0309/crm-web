# æ··åˆæƒé™ç®¡ç†ç³»ç»Ÿæ‰§è¡ŒæŒ‡å—

## ç³»ç»Ÿæ¶æ„æ¦‚è¿°

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ··åˆæƒé™ç®¡ç†ç³»ç»Ÿï¼Œç»“åˆäº†ï¼š

1. **`organizations.admin`** - ç»„ç»‡ç®¡ç†å‘˜å…³ç³»ï¼ˆç®€æ´ç›´è§‚ï¼‰
2. **`permissions`è¡¨** - ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼ˆçµæ´»æ‰©å±•ï¼‰
3. **é€’å½’æƒé™ç»§æ‰¿** - æ”¯æŒç»„ç»‡å±‚æ¬¡ç»“æ„

## æƒé™æ§åˆ¶é€»è¾‘

ç”¨æˆ·è¦æŸ¥çœ‹/ç®¡ç†è·Ÿè¿›è®°å½•ï¼Œå¿…é¡»**åŒæ—¶æ»¡è¶³**ä¸¤ä¸ªæ¡ä»¶ï¼š
- âœ… æ˜¯ç»„ç»‡çš„ç®¡ç†å‘˜ (`organizations.admin = user_id`)
- âœ… æ‹¥æœ‰ `lead_manage` æƒé™

## æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²æƒé™ç³»ç»Ÿ
```sql
-- åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œ
\i followups_rls_admin_with_permissions.sql
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- åˆ›å»º `permissions` å’Œ `user_permissions` è¡¨
- æ’å…¥åŸºç¡€æƒé™æ•°æ®ï¼ˆåŒ…æ‹¬ `lead_manage`ï¼‰
- è®¾ç½® `followups` è¡¨çš„ RLS ç­–ç•¥
- åˆ›å»ºæƒé™ç®¡ç†å‡½æ•°

### ç¬¬äºŒæ­¥ï¼šé…ç½®æå£«å†›æƒé™
```sql
-- åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œ
\i setup_lijunshi_lead_manage_permissions.sql
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- æŸ¥æ‰¾/åˆ›å»ºæå£«å†›ç”¨æˆ·å’ŒåŒ—è™¹æ¡¥å›½é™…ç¤¾åŒºç»„ç»‡
- è®¾ç½®æå£«å†›ä¸ºç»„ç»‡ç®¡ç†å‘˜
- æˆäºˆæå£«å†› `lead_manage` æƒé™
- åˆ›å»ºæµ‹è¯•æ•°æ®éªŒè¯æƒé™
- æ˜¾ç¤ºæƒé™é…ç½®çŠ¶æ€

## æƒé™éªŒè¯

æ‰§è¡Œå®Œæˆåï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

```
âœ… æå£«å†›æƒé™é…ç½®æˆåŠŸï¼
   - ç»„ç»‡ç®¡ç†å‘˜ï¼šåŒ—è™¹æ¡¥å›½é™…ç¤¾åŒº
   - æƒé™ï¼šlead_manage

=== æå£«å†›æƒé™éªŒè¯ç»“æœ ===
ç”¨æˆ·åç§°: æå£«å†›
æ‹¥æœ‰lead_manageæƒé™: true
æ˜¯ç»„ç»‡ç®¡ç†å‘˜: true
å¯ä»¥ç®¡ç†è·Ÿè¿›è®°å½•: true
ç®¡ç†çš„ç»„ç»‡: {åŒ—è™¹æ¡¥å›½é™…ç¤¾åŒº}
å¯è®¿é—®çš„è·Ÿè¿›è®°å½•æ•°: 1

ğŸ‰ æå£«å†›æƒé™é…ç½®æˆåŠŸï¼ç°åœ¨å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†éƒ¨é—¨çš„è·Ÿè¿›è®°å½•äº†ã€‚
```

## ç³»ç»Ÿç‰¹ç‚¹

### âœ… ä¼˜ç‚¹
1. **æƒé™å…³ç³»æ¸…æ™°**ï¼šç»„ç»‡ç®¡ç†å‘˜ + å…·ä½“æƒé™çš„åŒé‡éªŒè¯
2. **æ€§èƒ½ä¼˜ç§€**ï¼šç´¢å¼•ä¼˜åŒ–ï¼ŒæŸ¥è¯¢é«˜æ•ˆ
3. **æ‰©å±•æ€§å¼º**ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„æƒé™ç±»å‹
4. **å®‰å…¨æ€§é«˜**ï¼šé˜²æ­¢æƒé™æ»¥ç”¨ï¼Œç»†ç²’åº¦æ§åˆ¶

### ğŸ“‹ æƒé™ç±»å‹
- `lead_manage` - æ½œåœ¨å®¢æˆ·ç®¡ç†æƒé™
- `deal_manage` - äº¤æ˜“ç®¡ç†æƒé™
- `followup_manage` - è·Ÿè¿›è®°å½•ç®¡ç†æƒé™
- `team_manage` - å›¢é˜Ÿç®¡ç†æƒé™
- `report_view` - æŠ¥è¡¨æŸ¥çœ‹æƒé™

### ğŸ”§ ç®¡ç†å‡½æ•°
```sql
-- æˆäºˆæƒé™
SELECT grant_permission_to_user(
    'ç”¨æˆ·ID', 
    'lead_manage', 
    'æˆæƒäººID'
);

-- æ£€æŸ¥æƒé™
SELECT has_permission('lead_manage', 'ç”¨æˆ·ID');

-- ç®¡ç†æå£«å†›æƒé™ï¼ˆä¾¿æ·å‡½æ•°ï¼‰
SELECT manage_lijunshi_permissions('grant', 'lead_manage');
SELECT manage_lijunshi_permissions('revoke', 'lead_manage');
```

## ç»„ç»‡å±‚æ¬¡ç»“æ„æ”¯æŒ

ç³»ç»Ÿæ”¯æŒé€’å½’ç»„ç»‡ç®¡ç†ï¼š

```
åŒ—è™¹æ¡¥å›½é™…ç¤¾åŒº (æå£«å†›ç®¡ç†)
â”œâ”€â”€ é”€å”®éƒ¨
â”‚   â”œâ”€â”€ é”€å”®ä¸€ç»„
â”‚   â””â”€â”€ é”€å”®äºŒç»„
â””â”€â”€ å®¢æœéƒ¨
    â”œâ”€â”€ å®¢æœä¸€ç»„
    â””â”€â”€ å®¢æœäºŒç»„
```

æå£«å†›ä½œä¸ºåŒ—è™¹æ¡¥å›½é™…ç¤¾åŒºçš„ç®¡ç†å‘˜ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­éƒ¨é—¨æˆå‘˜çš„è·Ÿè¿›è®°å½•ã€‚

## å‰ç«¯é›†æˆ

æ›´æ–°å‰ç«¯çš„ `usePermissions` hookï¼š

```typescript
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥ç®¡ç†è·Ÿè¿›è®°å½•
const canManageFollowups = useMemo(() => {
  return permissions.some(p => p.name === 'lead_manage') && 
         isDepartmentAdmin;
}, [permissions, isDepartmentAdmin]);
```

## æ•…éšœæ’é™¤

### å¦‚æœæå£«å†›è¿˜æ˜¯çœ‹ä¸åˆ°è·Ÿè¿›è®°å½•ï¼š

1. **æ£€æŸ¥ç”¨æˆ·èº«ä»½**ï¼š
   ```sql
   SELECT * FROM users_profile WHERE nickname ILIKE '%æå£«å†›%';
   ```

2. **æ£€æŸ¥ç»„ç»‡ç®¡ç†å‘˜è®¾ç½®**ï¼š
   ```sql
   SELECT * FROM organizations WHERE admin = 'æå£«å†›çš„user_id';
   ```

3. **æ£€æŸ¥æƒé™åˆ†é…**ï¼š
   ```sql
   SELECT up.nickname, p.name, upp.is_active
   FROM user_permissions upp
   JOIN permissions p ON upp.permission_id = p.id
   JOIN users_profile up ON upp.user_id = up.user_id
   WHERE up.nickname ILIKE '%æå£«å†›%';
   ```

4. **ä½¿ç”¨æµ‹è¯•å‡½æ•°**ï¼š
   ```sql
   SELECT * FROM test_user_followup_permissions('æå£«å†›çš„user_id');
   ```

## åç»­æ‰©å±•

### æ·»åŠ æ–°æƒé™ç±»å‹
```sql
-- æ’å…¥æ–°æƒé™
INSERT INTO permissions (name, description, category) 
VALUES ('contract_manage', 'åˆåŒç®¡ç†æƒé™', 'business');

-- æˆäºˆç”¨æˆ·æƒé™
SELECT grant_permission_to_user('ç”¨æˆ·ID', 'contract_manage');
```

### æ·»åŠ æ–°çš„RLSç­–ç•¥
```sql
-- ä¸ºå…¶ä»–è¡¨æ·»åŠ ç±»ä¼¼çš„æƒé™æ§åˆ¶
CREATE POLICY "leads_manage_policy" 
ON public.leads
FOR SELECT
TO authenticated
USING (
    -- ç±»ä¼¼çš„æƒé™é€»è¾‘
    has_permission('lead_manage', auth.uid()) 
    AND EXISTS (/* ç»„ç»‡ç®¡ç†å‘˜é€»è¾‘ */)
);
```

## ç«‹å³æ‰§è¡Œ

1. åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­æŒ‰é¡ºåºæ‰§è¡Œä¸¤ä¸ªè„šæœ¬
2. æŸ¥çœ‹æ‰§è¡Œç»“æœå’Œæƒé™éªŒè¯ä¿¡æ¯
3. ç”¨æå£«å†›è´¦å·é‡æ–°ç™»å½•å‰ç«¯ç³»ç»Ÿ
4. ç¡®è®¤å¯ä»¥æŸ¥çœ‹éƒ¨é—¨æˆå‘˜çš„è·Ÿè¿›è®°å½•

è¿™ä¸ªç³»ç»Ÿæ—¢ä¿æŒäº†æ‚¨åŸæœ‰è®¾è®¡çš„ç®€æ´æ€§ï¼Œåˆå¢åŠ äº†æƒé™æ§åˆ¶çš„çµæ´»æ€§ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¹³è¡¡æ–¹æ¡ˆï¼ 