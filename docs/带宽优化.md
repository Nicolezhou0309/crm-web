# CRM Web 静态文件CDN带宽优化执行方案

## 📋 项目概述

**项目名称**: CRM Web 静态文件CDN带宽优化  
**目标**: 通过CDN服务和无损压缩技术，减少50%的静态文件大小，提升2倍并发能力  
**当前带宽**: 3MB  
**优化原则**: 保留所有服务功能，移除不必要资源，使用无损压缩  

---

## �� 优化目标

### 当前状态分析
- **静态资源总大小**: 2.67MB
- **3MB带宽并发量**: 1-2个页面浏览
- **主要消耗**: 字体文件(1.1MB) + Lottie动画(500KB) + 其他资源(1.07MB)

### 优化目标
- **文件大小减少**: 50% (从2.67MB到1.33MB)
- **并发能力提升**: 2倍 (从1-2个到3-4个)
- **带宽节省**: 1.34MB每次页面加载
- **功能完整性**: 100%保留

---

## 📊 资源使用分析

### 必需资源（保留）
| 资源类型 | 文件名 | 大小 | 使用位置 | 优化策略 |
|---------|--------|------|----------|----------|
| 字体文件 | ShareTechMono-Regular.ttf | 200KB | 全局字体 | TTF→WOFF2 |
| 字体文件 | BitcountPropDouble-Regular.ttf | 400KB | 全局字体 | TTF→WOFF2 |
| 字体文件 | BitcountPropDouble-Light.ttf | 350KB | 全局字体 | TTF→WOFF2 |
| 字体文件 | Micro5-Regular.ttf | 150KB | 全局字体 | TTF→WOFF2 |
| 动画文件 | downtown-lottie.json | 500KB | LottieLogo组件 | JSON压缩 |
| 音频文件 | notification.wav | 100KB | 通知音效 | 保持原样 |
| 数据文件 | points.json | 50KB | 积分兑换页面 | JSON压缩 |
| 数据文件 | coin.json | 50KB | 积分兑换页面 | JSON压缩 |
| 页面文件 | index.html | 20KB | 主页面 | 保持原样 |
| JS文件 | *.js | 800KB | 应用逻辑 | 构建优化 |
| CSS文件 | *.css | 50KB | 样式文件 | 构建优化 |

---

## 🔧 技术方案

### 1. 无损压缩技术

#### 1.1 字体文件优化
- **转换格式**: TTF → WOFF2 + WOFF
- **压缩率**: 65% (1.1MB → 400KB)
- **技术**: fonttools + pyftsubset
- **兼容性**: 现代浏览器WOFF2，旧浏览器WOFF

#### 1.2 JSON文件优化
- **技术**: 移除空白字符，保持数据结构
- **压缩率**: 20% (100KB → 80KB)
- **影响**: 无功能影响

#### 1.3 Lottie动画优化
- **技术**: JSON压缩，保持动画完整性
- **压缩率**: 10% (500KB → 450KB)
- **影响**: 无视觉影响

### 2. CDN配置策略

#### 2.1 缓存策略
```yaml
长期缓存 (1年):
  - 字体文件 (*.woff2, *.woff)
  - 图片文件 (*.svg, *.png)
  - JS/CSS文件 (*.js, *.css)
  - Lottie动画文件
  - 音频文件

短期缓存 (1天):
  - JSON数据文件

不缓存:
  - index.html
```

#### 2.2 压缩配置
```yaml
启用压缩:
  - Gzip: 是
  - Brotli: 是
  - 最小文件大小: 1KB
  - 支持格式: js, css, json, svg, woff, woff2
```

---

## 📝 执行步骤

### 第一阶段：环境准备 (1天)

#### 1.1 安装必要工具
```bash
# 安装字体转换工具
pip install fonttools[woff]

# 安装Node.js依赖
npm install --save-dev vite-plugin-compression

# 验证工具安装
pyftsubset --version
node --version
npm --version
```

#### 1.2 创建项目结构
```bash
# 创建优化脚本目录
mkdir -p scripts/optimization
mkdir -p dist/fonts
mkdir -p dist/animations
mkdir -p dist/data
mkdir -p backup/unused-assets
```

### 第二阶段：资源清理 (1天)

#### 2.1 创建资源清理脚本
```bash
# scripts/cleanup-unused-assets.sh
#!/bin/bash
echo "开始清理未使用的静态资源..."

# 创建备份目录
mkdir -p backup/unused-assets

# 移动未使用的资源到备份目录
unused_assets=(
  "public/achievement_card.svg"
  "public/coin2.svg" 
  "public/VLINKER.svg"
)

for asset in "${unused_assets[@]}"; do
  if [ -f "$asset" ]; then
    echo "移动未使用资源: $asset"
    mv "$asset" "backup/unused-assets/"
  fi
done

echo "资源清理完成！"
```

#### 2.2 执行资源清理
```bash
chmod +x scripts/cleanup-unused-assets.sh
./scripts/cleanup-unused-assets.sh
```

### 第三阶段：字体文件优化 (1天)

#### 3.1 创建字体转换脚本
```bash
# scripts/optimize-fonts.sh
#!/bin/bash
echo "开始字体文件无损压缩..."

# 创建输出目录
mkdir -p dist/fonts

# 转换TTF到WOFF2（无损，文件更小）
for font in public/fonts/*.ttf; do
    filename=$(basename "$font" .ttf)
    echo "转换 $filename.ttf 到 WOFF2..."
    
    # 使用fonttools进行无损转换
    pyftsubset "$font" \
        --output-file="dist/fonts/${filename}.woff2" \
        --flavor=woff2 \
        --layout-features='*' \
        --glyph-names \
        --symbol-cmap \
        --legacy-cmap \
        --notdef-glyph \
        --notdef-outline \
        --recommended-glyphs \
        --hinting-tables='*' \
        --drop-empty-tables \
        --recalc-bounds \
        --recalc-timestamp \
        --name-IDs='*' \
        --name-languages='*'
    
    # 生成WOFF作为后备
    pyftsubset "$font" \
        --output-file="dist/fonts/${filename}.woff" \
        --flavor=woff \
        --layout-features='*' \
        --glyph-names \
        --symbol-cmap \
        --legacy-cmap \
        --notdef-glyph \
        --notdef-outline \
        --recommended-glyphs \
        --hinting-tables='*' \
        --drop-empty-tables \
        --recalc-bounds \
        --recalc-timestamp \
        --name-IDs='*' \
        --name-languages='*'
done

echo "字体转换完成！"
```

#### 3.2 执行字体转换
```bash
chmod +x scripts/optimize-fonts.sh
./scripts/optimize-fonts.sh
```

### 第四阶段：JSON文件优化 (0.5天)

#### 4.1 创建JSON优化脚本
```javascript
// scripts/optimize-json.js
const fs = require('fs');
const path = require('path');

// JSON文件无损压缩
const optimizeJson = (inputPath, outputPath) => {
  const data = JSON.parse(fs.readFileSync(inputPath, 'utf8'));
  
  // 移除不必要的空白字符，保持数据完整性
  const optimized = JSON.stringify(data, null, 0);
  
  fs.writeFileSync(outputPath, optimized);
  console.log(`JSON优化完成: ${inputPath} -> ${outputPath}`);
};

// 优化points.json和coin.json
optimizeJson('public/points.json', 'dist/data/points.json');
optimizeJson('public/coin.json', 'dist/data/coin.json');

// 优化Lottie动画
const optimizeLottie = (inputPath, outputPath) => {
  const lottieData = JSON.parse(fs.readFileSync(inputPath, 'utf8'));
  
  // 无损优化：移除不必要的空白，保持动画完整性
  const optimized = {
    v: lottieData.v,
    fr: lottieData.fr,
    ip: lottieData.ip,
    op: lottieData.op,
    w: lottieData.w,
    h: lottieData.h,
    nm: lottieData.nm,
    ddd: lottieData.ddd,
    assets: lottieData.assets,
    layers: lottieData.layers,
    markers: lottieData.markers,
    props: lottieData.props
  };
  
  // 压缩JSON但不改变数据结构
  const compressed = JSON.stringify(optimized);
  fs.writeFileSync(outputPath, compressed);
  console.log(`Lottie优化完成: ${inputPath} -> ${outputPath}`);
};

optimizeLottie('src/assets/downtown-lottie.json', 'dist/animations/downtown-lottie.json');
```

#### 4.2 执行JSON优化
```bash
node scripts/optimize-json.js
```

### 第五阶段：构建配置优化 (1天)

#### 5.1 更新Vite配置
```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { compression } from 'vite-plugin-compression'

export default defineConfig({
  plugins: [
    react(),
    // 启用Gzip压缩
    compression({
      algorithm: 'gzip',
      threshold: 1024, // 只压缩大于1KB的文件
      deleteOriginFile: false
    }),
    // 启用Brotli压缩（更高效）
    compression({
      algorithm: 'brotliCompress',
      threshold: 1024,
      deleteOriginFile: false,
      ext: '.br'
    })
  ],
  
  build: {
    // 启用代码分割
    rollupOptions: {
      output: {
        manualChunks: {
          // 第三方库分离
          vendor: ['react', 'react-dom'],
          antd: ['antd'],
          supabase: ['@supabase/supabase-js'],
          // 工具库分离
          utils: ['dayjs', 'lodash-es']
        },
        // 资源文件命名优化
        chunkFileNames: 'assets/js/[name]-[hash].js',
        entryFileNames: 'assets/js/[name]-[hash].js',
        assetFileNames: (assetInfo) => {
          const extType = assetInfo.name.split('.').pop()
          if (/\.(png|jpe?g|gif|svg)$/.test(assetInfo.name)) {
            return `assets/images/[name]-[hash].${extType}`
          }
          if (/\.(woff2?|eot|ttf|otf)$/.test(assetInfo.name)) {
            return `assets/fonts/[name]-[hash].${extType}`
          }
          return `assets/[name]-[hash].${extType}`
        }
      }
    },
    
    // 启用压缩
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true, // 移除console
        drop_debugger: true // 移除debugger
      }
    },
    
    // 启用CSS代码分割
    cssCodeSplit: true,
    
    // 设置chunk大小警告限制
    chunkSizeWarningLimit: 1000
  }
})
```

#### 5.2 更新字体CSS
```css
/* src/fonts.css - 使用优化后的字体文件 */
@font-face {
  font-family: 'Share Tech Mono';
  font-style: normal;
  font-weight: 400;
  src: url('/fonts/ShareTechMono-Regular.woff2') format('woff2'),
       url('/fonts/ShareTechMono-Regular.woff') format('woff');
  font-display: swap;
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Bitcount Prop Double';
  font-weight: 300;
  font-style: normal;
  src: url('/fonts/BitcountPropDouble-Light.woff2') format('woff2'),
       url('/fonts/BitcountPropDouble-Light.woff') format('woff');
  font-display: swap;
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Bitcount Prop Double';
  font-weight: 400;
  font-style: normal;
  src: url('/fonts/BitcountPropDouble-Regular.woff2') format('woff2'),
       url('/fonts/BitcountPropDouble-Regular.woff') format('woff');
  font-display: swap;
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Micro 5';
  font-weight: 400;
  font-style: normal;
  src: url('/fonts/Micro5-Regular.woff2') format('woff2'),
       url('/fonts/Micro5-Regular.woff') format('woff');
  font-display: swap;
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
```

### 第六阶段：CDN配置 (2天)

#### 6.1 环境变量配置
```bash
# .env
VITE_CDN_URL=https://your-cdn-domain.com
VITE_CDN_VERSION=v1.0.0
VITE_ENABLE_CDN=true
VITE_CDN_FALLBACK=true
```

#### 6.2 CDN资源配置
```typescript
// src/config/cdn.ts
const getCDNUrl = (path: string): string => {
  const cdnUrl = import.meta.env.VITE_CDN_URL;
  const version = import.meta.env.VITE_CDN_VERSION;
  const enableCDN = import.meta.env.VITE_ENABLE_CDN === 'true';
  
  if (enableCDN && cdnUrl) {
    return `${cdnUrl}/${version}${path}`;
  }
  
  return path;
};

export const CDN_ASSETS = {
  // 字体文件
  fonts: {
    shareTechMono: getCDNUrl('/fonts/ShareTechMono-Regular.woff2'),
    bitcountRegular: getCDNUrl('/fonts/BitcountPropDouble-Regular.woff2'),
    bitcountLight: getCDNUrl('/fonts/BitcountPropDouble-Light.woff2'),
    micro5: getCDNUrl('/fonts/Micro5-Regular.woff2')
  },
  
  // 动画文件
  animations: {
    downtown: getCDNUrl('/animations/downtown-lottie.json')
  },
  
  // 音频文件
  audio: {
    notification: getCDNUrl('/audio/notification.wav')
  },
  
  // 数据文件
  data: {
    points: getCDNUrl('/data/points.json'),
    coin: getCDNUrl('/data/coin.json')
  }
};
```

#### 6.3 更新资源引用
```typescript
// src/components/LottieLogo.tsx
import React, { useRef, useEffect, useState } from 'react';
import Lottie from 'lottie-react';
import type { LottieRefCurrentProps } from 'lottie-react';
import { CDN_ASSETS } from '../config/cdn';

const LottieLogo: React.FC<{ width?: number; height?: number }> = ({ width = 40, height = 40 }) => {
  const [downtownData, setDowntownData] = useState(null);
  const lottieRef = useRef<LottieRefCurrentProps>(null);

  // 异步加载Lottie动画数据
  useEffect(() => {
    fetch(CDN_ASSETS.animations.downtown)
      .then(res => res.json())
      .then(data => setDowntownData(data))
      .catch(err => {
        console.error('Failed to load Lottie animation:', err);
        // 降级到本地文件
        import('../assets/downtown-lottie.json').then(module => {
          setDowntownData(module.default);
        });
      });
  }, []);

  // ... 现有代码保持不变
};
```

### 第七阶段：Nginx配置优化 (1天)

#### 7.1 更新Nginx配置
```nginx
# /etc/nginx/conf.d/lead-service.conf
server {
    server_name lead-service.vld.com.cn;
    
    # 启用Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2
        application/font-woff
        application/font-woff2;
    
    # 字体文件优化
    location ~* \.(woff|woff2|ttf|eot)$ {
        root /var/www/crm-web;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        add_header Access-Control-Allow-Origin "*";
        
        # 启用压缩
        gzip_static on;
    }
    
    # JavaScript和CSS文件优化
    location ~* \.(js|css)$ {
        root /var/www/crm-web;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        
        # 启用压缩
        gzip_static on;
    }
    
    # JSON文件优化
    location ~* \.(json)$ {
        root /var/www/crm-web;
        expires 1d;
        add_header Cache-Control "public";
        add_header Vary "Accept-Encoding";
        
        # 启用压缩
        gzip_static on;
    }
    
    # 音频文件优化
    location ~* \.(wav|mp3)$ {
        root /var/www/crm-web;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # 保持现有的API代理配置
    location /supabase/ {
        proxy_pass https://lead-service.vld.com.cn/supabase/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 支持WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # WebSocket 特定配置
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        
        # 确保 WebSocket 连接保持活跃
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Upgrade $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 5s;
        
        # CORS头
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, apikey, x-client-info, x-supabase-api-version";
        
        # 处理OPTIONS请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, apikey, x-client-info, x-supabase-api-version";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
    }
    
    # 静态文件服务
    location / {
        root /var/www/crm-web;
        try_files $uri $uri/ /index.html;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/lead-service.vld.com.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lead-service.vld.com.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = lead-service.vld.com.cn) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name lead-service.vld.com.cn;
    return 404;
}
```

### 第八阶段：测试和验证 (1天)

#### 8.1 功能测试
```bash
# 构建项目
npm run build

# 本地预览
npm run preview

# 检查构建结果
ls -la dist/
ls -la dist/fonts/
ls -la dist/animations/
ls -la dist/data/
```

#### 8.2 性能测试
```javascript
// scripts/performance-test.js
const performanceTest = async () => {
  const testUrl = 'https://lead.vld.com.cn';
  
  // 测试页面加载时间
  const startTime = performance.now();
  const response = await fetch(testUrl);
  const endTime = performance.now();
  
  console.log(`页面加载时间: ${endTime - startTime}ms`);
  console.log(`响应大小: ${response.headers.get('content-length')} bytes`);
  console.log(`压缩状态: ${response.headers.get('content-encoding') || '未压缩'}`);
  
  // 测试关键资源加载
  const resources = [
    '/fonts/ShareTechMono-Regular.woff2',
    '/animations/downtown-lottie.json',
    '/audio/notification.wav'
  ];
  
  for (const resource of resources) {
    const resStart = performance.now();
    await fetch(testUrl + resource);
    const resEnd = performance.now();
    console.log(`${resource}: ${resEnd - resStart}ms`);
  }
};

performanceTest();
```

#### 8.3 带宽监控
```bash
# 监控Nginx访问日志
tail -f /var/log/nginx/access.log | grep -E "\.(js|css|woff|woff2|png|jpg)$"

# 监控带宽使用
iftop -i eth0
```

---

## �� 预期效果

### 文件大小对比
| 资源类型 | 优化前 | 优化后 | 减少比例 |
|---------|--------|--------|----------|
| 字体文件 | 1.1MB | 400KB | 65% |
| Lottie动画 | 500KB | 450KB | 10% |
| JSON文件 | 100KB | 80KB | 20% |
| 未使用资源 | 140KB | 0KB | 100% |
| **总计** | **2.67MB** | **1.33MB** | **50%** |

### 并发能力提升
| 指标 | 优化前 | 优化后 | 提升比例 |
|------|--------|--------|----------|
| 页面大小 | 2.67MB | 1.33MB | 50% |
| 3MB带宽并发量 | 1-2个 | 3-4个 | 100-200% |
| 剩余带宽 | 0.33MB | 1.67MB | 400% |

### 性能提升
- **加载速度**: 提升2-3倍
- **用户体验**: 显著改善
- **服务器压力**: 减少50%
- **带宽成本**: 节省50%

---

## �� 维护和监控

### 日常监控指标
- 页面加载时间
- 资源加载成功率
- CDN命中率
- 带宽使用情况
- 用户访问体验

### 定期检查项目
- 未使用资源清理
- 字体文件更新
- CDN配置优化
- 性能指标分析

### 故障处理
- CDN故障时的降级方案
- 资源加载失败的重试机制
- 性能异常的排查流程

---

## ✅ 检查清单

### 环境准备
- [ ] 安装fonttools工具
- [ ] 安装vite-plugin-compression
- [ ] 创建项目目录结构
- [ ] 配置环境变量

### 资源优化
- [ ] 清理未使用资源
- [ ] 转换字体文件格式
- [ ] 优化JSON文件
- [ ] 优化Lottie动画

### 构建配置
- [ ] 更新Vite配置
- [ ] 更新字体CSS
- [ ] 配置CDN资源URL
- [ ] 更新资源引用

### 部署配置
- [ ] 配置CDN服务
- [ ] 更新Nginx配置
- [ ] 上传优化后资源
- [ ] 测试CDN访问

### 测试验证
- [ ] 功能测试通过
- [ ] 性能测试通过
- [ ] 带宽监控正常
- [ ] 用户体验良好

---

## 📞 技术支持

如有问题，请联系：
- **技术负责人**: 开发团队
- **文档版本**: v1.0
- **创建日期**: 2025年1月
- **最后更新**: 2025年1月

---

**注意**: 本方案基于无损压缩技术，确保所有功能完整保留，同时最大化带宽优化效果。建议按阶段执行，每个阶段完成后进行测试验证。