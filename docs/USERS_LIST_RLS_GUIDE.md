# Users List 表 RLS 策略指南

## 概述

本文档描述了 `users_list` 表的行级安全（RLS）策略设计和使用方法。

## 表结构

```sql
CREATE TABLE public.users_list (
  id bigint generated by default as identity not null,
  groupname text null,
  list bigint[] null,
  description text null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone null default now(),
  allocation public.allocation_method null default 'round_robin'::allocation_method,
  enable_quality_control boolean null default false,
  daily_lead_limit integer null,
  conversion_rate_requirement numeric(5, 2) null default null::numeric,
  max_pending_leads integer null,
  quality_control_config jsonb null,
  enable_community_matching boolean null default true,
  community public.community null,
  constraint users_list_pkey primary key (id),
  constraint users_list_community_key unique (community),
  constraint users_list_groupname_unique unique (groupname)
);
```

## RLS 策略设计

### 权限矩阵

| 操作 | 权限要求 | 说明 |
|------|----------|------|
| 插入 (INSERT) | `allocation_manage` | 只有具有分配管理权限的用户可以创建新的用户列表 |
| 删除 (DELETE) | `allocation_manage` | 只有具有分配管理权限的用户可以删除用户列表 |
| 更新 (UPDATE) | 所有注册用户 | 任何已认证的用户都可以更新用户列表 |
| 查询 (SELECT) | 所有注册用户 | 任何已认证的用户都可以查看用户列表 |

### 策略实现

```sql
-- 启用 RLS
ALTER TABLE public.users_list ENABLE ROW LEVEL SECURITY;

-- 插入策略
CREATE POLICY "users_list_insert_policy" ON public.users_list
    FOR INSERT
    WITH CHECK (
        has_permission('users_list', 'allocation_manage')
    );

-- 删除策略
CREATE POLICY "users_list_delete_policy" ON public.users_list
    FOR DELETE
    USING (
        has_permission('users_list', 'allocation_manage')
    );

-- 更新策略
CREATE POLICY "users_list_update_policy" ON public.users_list
    FOR UPDATE
    USING (
        auth.role() = 'authenticated'
    )
    WITH CHECK (
        auth.role() = 'authenticated'
    );

-- 查询策略
CREATE POLICY "users_list_select_policy" ON public.users_list
    FOR SELECT
    USING (
        auth.role() = 'authenticated'
    );
```

## 部署方法

### 方法 1：使用部署脚本

```bash
./deploy-users-list-rls.sh
```

### 方法 2：手动执行 SQL

```bash
# 连接到 Supabase
supabase db reset --linked

# 或者直接执行 SQL 文件
psql -h your-supabase-host -U postgres -d postgres -f sql-scripts/setup/users_list_rls_policies.sql
```

## 权限验证

### 检查用户权限

```sql
-- 检查当前用户是否有 allocation_manage 权限
SELECT has_permission('users_list', 'allocation_manage') as can_manage_allocation;

-- 检查当前用户的所有权限
SELECT 
    p.resource,
    p.action,
    p.description
FROM public.user_roles ur
JOIN public.role_permissions rp ON ur.role_id = rp.role_id
JOIN public.permissions p ON rp.permission_id = p.id
WHERE ur.user_id = auth.uid();
```

### 测试策略

```sql
-- 运行测试脚本
\i sql-scripts/setup/test_users_list_rls.sql
```

## 使用示例

### 前端代码示例

```typescript
// 检查用户权限
const canManageAllocation = await supabase
  .rpc('has_permission', {
    resource: 'users_list',
    action: 'allocation_manage'
  });

// 根据权限显示不同的操作按钮
if (canManageAllocation.data) {
  // 显示创建和删除按钮
} else {
  // 只显示查看和编辑按钮
}
```

### API 调用示例

```typescript
// 创建用户列表（需要 allocation_manage 权限）
const createUserList = async (data: UserListData) => {
  const { data: result, error } = await supabase
    .from('users_list')
    .insert(data);
  
  if (error) {
    console.error('创建失败，可能是权限不足:', error);
  }
  
  return { data: result, error };
};

// 更新用户列表（所有注册用户都可以）
const updateUserList = async (id: number, data: Partial<UserListData>) => {
  const { data: result, error } = await supabase
    .from('users_list')
    .update(data)
    .eq('id', id);
  
  return { data: result, error };
};
```

## 故障排除

### 常见问题

1. **权限被拒绝错误**
   - 检查用户是否有 `allocation_manage` 权限
   - 确认用户已正确登录

2. **策略不生效**
   - 确认 RLS 已启用：`SELECT rowsecurity FROM pg_tables WHERE tablename = 'users_list';`
   - 检查策略是否存在：`SELECT * FROM pg_policies WHERE tablename = 'users_list';`

3. **has_permission 函数错误**
   - 确认函数存在：`SELECT has_permission('users_list', 'allocation_manage');`
   - 检查用户角色和权限配置

### 调试命令

```sql
-- 检查当前用户
SELECT auth.uid() as current_user_id, auth.role() as current_role;

-- 检查用户角色
SELECT * FROM public.user_roles WHERE user_id = auth.uid();

-- 检查权限
SELECT * FROM public.permissions WHERE resource = 'users_list';

-- 检查策略
SELECT * FROM pg_policies WHERE tablename = 'users_list';
```

## 安全注意事项

1. **权限最小化原则**：只给用户必要的权限
2. **定期审查**：定期检查权限配置是否正确
3. **日志记录**：记录重要的权限操作
4. **测试覆盖**：确保所有权限场景都有测试覆盖

## 更新历史

- 2025-01-15：初始版本，创建基本的 RLS 策略 