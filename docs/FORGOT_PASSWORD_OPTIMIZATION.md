# å¿˜è®°å¯†ç åŠŸèƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

ä¼˜åŒ–å¿˜è®°å¯†ç çš„é€»è¾‘ï¼Œå…ˆæ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨ï¼Œå†å‘é€é‡ç½®å¯†ç é‚®ä»¶ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### åŸæœ‰é—®é¢˜
1. **ç›´æ¥å‘é€é‡ç½®é‚®ä»¶**ï¼šæ— è®ºé‚®ç®±æ˜¯å¦å­˜åœ¨éƒ½ä¼šå‘é€é‡ç½®é‚®ä»¶
2. **ç”¨æˆ·ä½“éªŒå·®**ï¼šç”¨æˆ·è¾“å…¥é”™è¯¯é‚®ç®±æ—¶ï¼Œç³»ç»Ÿä»ä¼šæ˜¾ç¤º"é‚®ä»¶å·²å‘é€"
3. **å®‰å…¨æ€§é—®é¢˜**ï¼šå¯èƒ½æ³„éœ²ç”¨æˆ·æ³¨å†Œä¿¡æ¯
4. **èµ„æºæµªè´¹**ï¼šå‘ä¸å­˜åœ¨çš„é‚®ç®±å‘é€é‚®ä»¶

### ä¼˜åŒ–æ–¹æ¡ˆ
é€šè¿‡æŸ¥è¯¢ `users_profile` è¡¨æ¥éªŒè¯é‚®ç®±æ˜¯å¦å­˜åœ¨ï¼Œå¹¶æä¾›æ˜ç¡®çš„çŠ¶æ€åé¦ˆã€‚

## ğŸ› ï¸ å®ç°æ–¹æ¡ˆ

### 1. æ ¸å¿ƒé€»è¾‘ä¼˜åŒ–

```typescript
const handleResetPassword = async () => {
  // 1. é‚®ç®±æ ¼å¼éªŒè¯
  if (!resetEmail || !/^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/.test(resetEmail)) {
    message.error('è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±');
    return;
  }
  
  setResetLoading(true);
  
  try {
    // 2. æŸ¥è¯¢ users_profile è¡¨æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
    const { data: profileData, error: profileError } = await supabase
      .from('users_profile')
      .select('id, email, status, user_id')
      .eq('email', resetEmail)
      .single();
    
    // 3. å¤„ç†æŸ¥è¯¢ç»“æœ
    if (profileError) {
      if (profileError.code === 'PGRST116') {
        message.error('è¯¥é‚®ç®±æœªæ³¨å†Œï¼Œè¯·æ£€æŸ¥é‚®ç®±åœ°å€');
        return;
      } else {
        message.error('æ£€æŸ¥é‚®ç®±æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
        return;
      }
    }
    
    // 4. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if (profileData.status === 'banned' || profileData.status === 'deleted') {
      message.error('è¯¥è´¦å·å·²è¢«ç¦ç”¨æˆ–åˆ é™¤ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
      return;
    }
    
    if (profileData.status === 'pending') {
      message.error('è¯¥é‚®ç®±å°šæœªæ¿€æ´»ï¼Œè¯·å…ˆæ¿€æ´»è´¦å·');
      return;
    }
    
    // 5. å‘é€é‡ç½®å¯†ç é‚®ä»¶
    const redirectTo = window.location.origin + '/set-password';
    const { error } = await supabase.auth.resetPasswordForEmail(resetEmail, {
      redirectTo,
    });
    
    if (error) {
      message.error(error.message || 'é‡ç½®é‚®ä»¶å‘é€å¤±è´¥');
    } else {
      message.success('é‡ç½®å¯†ç é‚®ä»¶å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ç®±ï¼');
      setResetModalVisible(false);
    }
  } catch (e) {
    console.error('é‡ç½®å¯†ç é”™è¯¯:', e);
    message.error('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    setResetLoading(false);
  }
};
```

### 2. ç”¨æˆ·çŠ¶æ€æ£€æŸ¥

| çŠ¶æ€ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `active` | æ­£å¸¸ç”¨æˆ· | å…è®¸å‘é€é‡ç½®é‚®ä»¶ |
| `pending` | æœªæ¿€æ´»ç”¨æˆ· | æç¤ºå…ˆæ¿€æ´»è´¦å· |
| `banned` | è¢«ç¦ç”¨ç”¨æˆ· | æç¤ºè”ç³»ç®¡ç†å‘˜ |
| `deleted` | å·²åˆ é™¤ç”¨æˆ· | æç¤ºè”ç³»ç®¡ç†å‘˜ |

### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–

```typescript
// é”™è¯¯ç å¤„ç†
if (profileError.code === 'PGRST116') {
  // æ²¡æœ‰æ‰¾åˆ°è®°å½•
  message.error('è¯¥é‚®ç®±æœªæ³¨å†Œï¼Œè¯·æ£€æŸ¥é‚®ç®±åœ°å€');
} else {
  // å…¶ä»–æŸ¥è¯¢é”™è¯¯
  message.error('æ£€æŸ¥é‚®ç®±æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
}

// ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
if (profileData.status === 'banned' || profileData.status === 'deleted') {
  message.error('è¯¥è´¦å·å·²è¢«ç¦ç”¨æˆ–åˆ é™¤ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
} else if (profileData.status === 'pending') {
  message.error('è¯¥é‚®ç®±å°šæœªæ¿€æ´»ï¼Œè¯·å…ˆæ¿€æ´»è´¦å·');
}
```

## ğŸ“Š æ•°æ®åº“æŸ¥è¯¢

### users_profile è¡¨ç»“æ„
```sql
CREATE TABLE public.users_profile (
  id bigserial PRIMARY KEY,
  user_id uuid NULL,
  organization_id uuid NULL,
  nickname text NULL,
  email text NULL,
  status text NULL,
  updated_at timestamp with time zone NULL DEFAULT (now() AT TIME ZONE 'UTC'::text)
);
```

### æŸ¥è¯¢é€»è¾‘
```sql
-- æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
SELECT id, email, status, user_id 
FROM users_profile 
WHERE email = 'user@example.com' 
LIMIT 1;
```

## ğŸ”’ æƒé™æ§åˆ¶

### RLS ç­–ç•¥
```sql
-- å…è®¸æ‰€æœ‰ç”¨æˆ·æŸ¥çœ‹ users_profile è¡¨
CREATE POLICY "users_profile_select_policy" ON "public"."users_profile"
FOR SELECT TO public
USING (true);
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
1. **å­˜åœ¨é‚®ç®±æµ‹è¯•**ï¼šéªŒè¯èƒ½æ­£ç¡®æ‰¾åˆ°ç”¨æˆ·æ¡£æ¡ˆ
2. **ä¸å­˜åœ¨é‚®ç®±æµ‹è¯•**ï¼šéªŒè¯èƒ½æ­£ç¡®è¯†åˆ«æœªæ³¨å†Œé‚®ç®±
3. **ç”¨æˆ·çŠ¶æ€æµ‹è¯•**ï¼šéªŒè¯ä¸åŒçŠ¶æ€ç”¨æˆ·çš„å¤„ç†
4. **é”™è¯¯å¤„ç†æµ‹è¯•**ï¼šéªŒè¯å¼‚å¸¸æƒ…å†µçš„å¤„ç†

### æµ‹è¯•è„šæœ¬
```bash
# è¿è¡Œæµ‹è¯•
node test-reset-password.js
```

## ğŸ‰ ä¼˜åŒ–æ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡
- âœ… **æ˜ç¡®åé¦ˆ**ï¼šç”¨æˆ·èƒ½ç«‹å³çŸ¥é“é‚®ç®±æ˜¯å¦å­˜åœ¨
- âœ… **çŠ¶æ€æç¤º**ï¼šæ¸…æ¥šå‘ŠçŸ¥ç”¨æˆ·è´¦å·çŠ¶æ€
- âœ… **é”™è¯¯å¼•å¯¼**ï¼šæä¾›å…·ä½“çš„è§£å†³å»ºè®®

### å®‰å…¨æ€§æå‡
- âœ… **ä¿¡æ¯ä¿æŠ¤**ï¼šé¿å…æ³„éœ²ç”¨æˆ·æ³¨å†Œä¿¡æ¯
- âœ… **çŠ¶æ€éªŒè¯**ï¼šç¡®ä¿åªæœ‰æ­£å¸¸ç”¨æˆ·èƒ½é‡ç½®å¯†ç 
- âœ… **æƒé™æ§åˆ¶**ï¼šé€šè¿‡ RLS ç­–ç•¥æ§åˆ¶æ•°æ®è®¿é—®

### ç³»ç»Ÿæ€§èƒ½æå‡
- âœ… **èµ„æºèŠ‚çº¦**ï¼šé¿å…å‘ä¸å­˜åœ¨çš„é‚®ç®±å‘é€é‚®ä»¶
- âœ… **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•åŠ é€Ÿé‚®ç®±æŸ¥è¯¢
- âœ… **é”™è¯¯å‡å°‘**ï¼šå‡å°‘æ— æ•ˆçš„é‚®ä»¶å‘é€

## ğŸ“ éƒ¨ç½²è¯´æ˜

### 1. ä»£ç æ›´æ–°
- æ›´æ–° `src/pages/Login.tsx` ä¸­çš„ `handleResetPassword` å‡½æ•°
- ç¡®ä¿ RLS ç­–ç•¥å·²æ­£ç¡®é…ç½®

### 2. æµ‹è¯•éªŒè¯
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
node test-reset-password.js

# æ‰‹åŠ¨æµ‹è¯•
# 1. è¾“å…¥ä¸å­˜åœ¨çš„é‚®ç®±
# 2. è¾“å…¥å·²ç¦ç”¨ç”¨æˆ·çš„é‚®ç®±
# 3. è¾“å…¥æ­£å¸¸ç”¨æˆ·çš„é‚®ç®±
```

### 3. ç›‘æ§æŒ‡æ ‡
- é‡ç½®å¯†ç è¯·æ±‚æˆåŠŸç‡
- ç”¨æˆ·åé¦ˆæ»¡æ„åº¦
- é‚®ä»¶å‘é€æˆåŠŸç‡

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æŸ¥è¯¢å¤±è´¥
**é—®é¢˜**ï¼šæ— æ³•æŸ¥è¯¢ `users_profile` è¡¨
**è§£å†³**ï¼šæ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®

#### 2. çŠ¶æ€åˆ¤æ–­é”™è¯¯
**é—®é¢˜**ï¼šç”¨æˆ·çŠ¶æ€åˆ¤æ–­ä¸å‡†ç¡®
**è§£å†³**ï¼šæ£€æŸ¥ `users_profile` è¡¨çš„çŠ¶æ€åŒæ­¥é€»è¾‘

#### 3. é‚®ä»¶å‘é€å¤±è´¥
**é—®é¢˜**ï¼šé‡ç½®é‚®ä»¶å‘é€å¤±è´¥
**è§£å†³**ï¼šæ£€æŸ¥ Supabase é‚®ä»¶é…ç½®å’Œç½‘ç»œè¿æ¥

### è°ƒè¯•æ–¹æ³•
```typescript
// æ·»åŠ è°ƒè¯•æ—¥å¿—
console.log('æŸ¥è¯¢ç”¨æˆ·æ¡£æ¡ˆ:', { email: resetEmail });
console.log('æŸ¥è¯¢ç»“æœ:', { data: profileData, error: profileError });
console.log('ç”¨æˆ·çŠ¶æ€:', profileData?.status);
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æ¡£æ¡ˆåŒæ­¥æŒ‡å—](./USERS_PROFILE_SYNC_GUIDE.md)
- [æƒé™ç®¡ç†ç³»ç»ŸæŒ‡å—](./æ··åˆæƒé™ç®¡ç†ç³»ç»Ÿæ‰§è¡ŒæŒ‡å—.md)
- [Supabase é…ç½®æŒ‡å—](./SUPABASE_CONFIG.md)

---

**æ›´æ–°æ—¶é—´**: 2024å¹´12æœˆ
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²å¹¶æµ‹è¯• 