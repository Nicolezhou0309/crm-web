ROSTemplateFormatVersion: '2015-09-01'
Transform: 'Aliyun::Serverless-2018-04-03'

Resources:
  crm-frontend:
    Type: 'Aliyun::Serverless::Service'
    Properties:
      Description: 'CRM前端应用服务 - Vite + React + Function Compute'
      Policies:
        - AliyunOSSFullAccess
        - AliyunLogFullAccess
        - AliyunFCReadOnlyAccess
      LogConfig:
        Project: crm-logs
        Logstore: crm-function-logs
      VpcConfig:
        VpcId: vpc-xxx
        VswitchIds:
          - vsw-xxx
        SecurityGroupId: sg-xxx
    
    crm-frontend-app:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Description: 'CRM前端应用函数 - 适配Vite构建'
        CodeUri: './'
        Handler: index.handler
        Runtime: nodejs18
        MemorySize: 1024
        Timeout: 60
        InstanceConcurrency: 10
        InstanceType: e1
        EnvironmentVariables:
          VITE_SUPABASE_URL: 'http://47.123.26.25:8000'
          VITE_SUPABASE_ANON_KEY: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiYW5vbiIsInJlZiI6InNicC04b2gxOG0wM2hiYjA4N3RhIiwiaXNzIjoic3VwYWJhc2UiLCJpYXQiOjE3NTU0MjI4MjEsImV4cCI6MjA3MDk5ODgyMX0.TMNhVSwNgrJHxRKQnV-GVzX_EovIQ6EIg2vXdQEWRgE'
          VITE_SUPABASE_SERVICE_ROLE_KEY: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiYW5vbiIsInJlZiI6InNicC04b2gxOG0wM2hiYjA4N3RhIiwiaXNzIjoic3VwYWJhc2UiLCJpYXQiOjE3NTU0MjI4MjEsImV4cCI6MjA3MDk5ODgyMX0.TMNhVSwNgrJHxRKQnV-GVzX_EovIQ6EIg2vXdQEWRgE'
          VITE_APP_ENV: 'production'
          VITE_APP_VERSION: '1.0.0'
          VITE_WECOM_CORP_ID: 'ww68a125fce698cb59'
          VITE_WECOM_AGENT_ID: '1000002'
          NODE_ENV: 'production'
        AsyncConfiguration:
          MaxAsyncEventAgeInSeconds: 300
          MaxAsyncRetryAttempts: 2
        EventInvokeConfig:
          DestinationConfig:
            OnSuccess:
              Type: MNS
              Destination: acs:mns:cn-shanghai:123456789012:queues/function-compute-success
            OnFailure:
              Type: MNS
              Destination: acs:mns:cn-shanghai:123456789012:queues/function-compute-failure
      Events:
        http-trigger:
          Type: HTTP
          Properties:
            AuthType: ANONYMOUS
            Methods: ['GET', 'POST', 'PUT', 'DELETE', 'HEAD', 'OPTIONS', 'PATCH']
            Path: '/{proxy+}'
            Cors:
              AllowOrigin: '*'
              AllowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'HEAD', 'OPTIONS', 'PATCH']
              AllowHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'X-Client-Info']
              ExposeHeaders: ['Content-Length', 'X-Kuma-Revision']
              MaxAge: 86400
        api-trigger:
          Type: HTTP
          Properties:
            AuthType: ANONYMOUS
            Methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
            Path: '/api/{proxy+}'
            Cors:
              AllowOrigin: '*'
              AllowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
              AllowHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
              MaxAge: 3600

Outputs:
  ServiceName:
    Value:
      Fn::GetAtt: [crm-frontend, Name]
    Description: 'CRM前端服务名称'
  
  FunctionName:
    Value:
      Fn::GetAtt: [crm-frontend-app, Name]
    Description: 'CRM前端函数名称'
  
  HttpTriggerUrl:
    Value:
      Fn::GetAtt: [crm-frontend-app, HttpTriggerUrl]
    Description: 'HTTP触发器访问地址'
  
  ApiTriggerUrl:
    Value:
      Fn::GetAtt: [crm-frontend-app, ApiTriggerUrl]
    Description: 'API触发器访问地址'
