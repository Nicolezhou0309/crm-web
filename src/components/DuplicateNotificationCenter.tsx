import React, { useState, useEffect } from 'react';
import { Card, List, Badge, Button, Tag, Modal, Descriptions, Space, Typography, Tooltip, Empty, Spin } from 'antd';
import { BellOutlined, CheckOutlined, EyeOutlined, InfoCircleOutlined } from '@ant-design/icons';
import type { DuplicateNotification } from '../types/allocation';
import { NOTIFICATION_STATUSES, DUPLICATE_TYPES } from '../types/allocation';
import dayjs from 'dayjs';

const { Text, Title } = Typography;

interface DuplicateNotificationCenterProps {
  userId: number;
  onNotificationChange?: (count: number) => void;
}

export const DuplicateNotificationCenter: React.FC<DuplicateNotificationCenterProps> = ({
  userId,
  onNotificationChange
}) => {
  const [notifications, setNotifications] = useState<DuplicateNotification[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedNotification, setSelectedNotification] = useState<DuplicateNotification | null>(null);
  const [detailModalVisible, setDetailModalVisible] = useState(false);

  useEffect(() => {
    loadNotifications();
    // ËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÊØè30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
    const interval = setInterval(loadNotifications, 30000);
    return () => clearInterval(interval);
  }, [userId]);

  useEffect(() => {
    // ÈÄöÁü•Áà∂ÁªÑ‰ª∂Êú™Â§ÑÁêÜÈÄöÁü•Êï∞Èáè
    const pendingCount = notifications.filter(n => n.notification_status === 'pending').length;
    onNotificationChange?.(pendingCount);
  }, [notifications, onNotificationChange]);

  const loadNotifications = async () => {
    setLoading(true);
    try {
      // TODO: ÂÆûÁé∞ÈáçÂ§çÈÄöÁü•ÂäüËÉΩ
      ('Ëé∑ÂèñÈÄöÁü•ÂäüËÉΩÂæÖÂÆûÁé∞', userId);
      setNotifications([]);
    } catch (error) {
      console.error('Âä†ËΩΩÈáçÂ§çÂÆ¢Êà∑ÈÄöÁü•Â§±Ë¥•:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleNotificationClick = (notification: DuplicateNotification) => {
    setSelectedNotification(notification);
    setDetailModalVisible(true);
    
    // Â¶ÇÊûúÈÄöÁü•Áä∂ÊÄÅÊòØpendingÔºåËá™Âä®Ê†áËÆ∞‰∏∫read
    if (notification.notification_status === 'pending') {
      markAsRead(notification.id);
    }
  };

  const markAsRead = async (notificationId: string) => {
    try {
      // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®APIÊ†áËÆ∞‰∏∫Â∑≤ËØªÔºåÊöÇÊó∂Âè™Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
      setNotifications(prev => 
        prev.map(n => 
          n.id === notificationId 
            ? { ...n, notification_status: 'read' as const }
            : n
        )
      );
    } catch (error) {
      console.error('Ê†áËÆ∞ÈÄöÁü•‰∏∫Â∑≤ËØªÂ§±Ë¥•:', error);
    }
  };

  const handleNotification = async (notificationId: string) => {
    try {
      // TODO: ÂÆûÁé∞Â§ÑÁêÜÈÄöÁü•ÂäüËÉΩ
      ('Â§ÑÁêÜÈÄöÁü•ÂäüËÉΩÂæÖÂÆûÁé∞', notificationId);
      setNotifications(prev => 
        prev.map(n => 
          n.id === notificationId 
            ? { ...n, notification_status: 'handled' as const, handled_at: new Date().toISOString() }
            : n
        )
      );
      setDetailModalVisible(false);
    } catch (error) {
      console.error('Â§ÑÁêÜÈÄöÁü•Â§±Ë¥•:', error);
    }
  };

  const getStatusColor = (status: string) => {
    const statusConfig = NOTIFICATION_STATUSES.find(s => s.value === status);
    return statusConfig?.color || 'default';
  };

  const getStatusText = (status: string) => {
    const statusMap = {
      'pending': 'ÂæÖÂ§ÑÁêÜ',
      'sent': 'Â∑≤ÂèëÈÄÅ',
      'read': 'Â∑≤Êü•Áúã',
      'handled': 'Â∑≤Â§ÑÁêÜ'
    };
    return statusMap[status as keyof typeof statusMap] || status;
  };

  const getDuplicateTypeInfo = (type: string) => {
    const typeConfig = DUPLICATE_TYPES.find(t => t.value === type);
    return typeConfig || { label: type, icon: 'üîÑ' };
  };

  const renderNotificationItem = (notification: DuplicateNotification) => {
    const typeInfo = getDuplicateTypeInfo(notification.duplicate_type);
    const isUnread = notification.notification_status === 'pending';
    
    return (
      <List.Item
        key={notification.id}
        onClick={() => handleNotificationClick(notification)}
        style={{ 
          cursor: 'pointer',
          backgroundColor: isUnread ? '#f6ffed' : 'transparent',
          border: isUnread ? '1px solid #b7eb8f' : '1px solid transparent',
          borderRadius: '6px',
          marginBottom: '8px',
          padding: '12px'
        }}
      >
        <List.Item.Meta
          avatar={
            <Badge dot={isUnread}>
              <div style={{ fontSize: '24px' }}>{typeInfo.icon}</div>
            </Badge>
          }
          title={
            <Space>
              <Text strong={isUnread}>ÈáçÂ§çÂÆ¢Êà∑ÈÄöÁü•</Text>
              <Tag color={getStatusColor(notification.notification_status)}>
                {getStatusText(notification.notification_status)}
              </Tag>
            </Space>
          }
          description={
            <div>
              <div style={{ marginBottom: '4px' }}>
                <Text type="secondary">{typeInfo.label}</Text>
              </div>
              <div style={{ marginBottom: '4px' }}>
                <Text>Êñ∞Á∫øÁ¥¢: {notification.new_leadid}</Text>
                {notification.original_leadid && (
                  <Text style={{ marginLeft: '12px' }}>
                    ÂéüÁ∫øÁ¥¢: {notification.original_leadid}
                  </Text>
                )}
              </div>
              <div>
                <Text type="secondary" style={{ fontSize: '12px' }}>
                  {dayjs(notification.created_at).format('YYYY-MM-DD HH:mm:ss')}
                </Text>
              </div>
            </div>
          }
        />
        <div>
          <Tooltip title="Êü•ÁúãËØ¶ÊÉÖ">
            <Button type="text" icon={<EyeOutlined />} />
          </Tooltip>
        </div>
      </List.Item>
    );
  };

  const pendingNotifications = notifications.filter(n => n.notification_status === 'pending');
  const otherNotifications = notifications.filter(n => n.notification_status !== 'pending');

  return (
    <>
      <Card 
        title={
          <Space>
            <BellOutlined />
            <span>ÈáçÂ§çÂÆ¢Êà∑ÈÄöÁü•</span>
            {pendingNotifications.length > 0 && (
              <Badge count={pendingNotifications.length} />
            )}
          </Space>
        }
        extra={
          <Button onClick={loadNotifications} loading={loading}>
            Âà∑Êñ∞
          </Button>
        }
      >
        <Spin spinning={loading}>
          {notifications.length === 0 ? (
            <Empty 
              description="ÊöÇÊó†ÈáçÂ§çÂÆ¢Êà∑ÈÄöÁü•" 
              image={Empty.PRESENTED_IMAGE_SIMPLE}
            />
          ) : (
            <div>
              {/* ÂæÖÂ§ÑÁêÜÈÄöÁü• */}
              {pendingNotifications.length > 0 && (
                <div style={{ marginBottom: '16px' }}>
                  <Title level={5} style={{ color: '#fa8c16' }}>
                    ÂæÖÂ§ÑÁêÜÈÄöÁü• ({pendingNotifications.length})
                  </Title>
                  <List
                    dataSource={pendingNotifications}
                    renderItem={renderNotificationItem}
                    pagination={false}
                  />
                </div>
              )}

              {/* ÂÖ∂‰ªñÈÄöÁü• */}
              {otherNotifications.length > 0 && (
                <div>
                  <Title level={5} style={{ color: '#666' }}>
                    ÂéÜÂè≤ÈÄöÁü• ({otherNotifications.length})
                  </Title>
                  <List
                    dataSource={otherNotifications.slice(0, 10)} // Âè™ÊòæÁ§∫ÊúÄËøë10Êù°
                    renderItem={renderNotificationItem}
                    pagination={false}
                  />
                </div>
              )}
            </div>
          )}
        </Spin>
      </Card>

      {/* ÈÄöÁü•ËØ¶ÊÉÖÂºπÁ™ó */}
      <Modal
        title="ÈáçÂ§çÂÆ¢Êà∑ËØ¶ÊÉÖ"
        open={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={
          selectedNotification && selectedNotification.notification_status !== 'handled' ? [
            <Button key="cancel" onClick={() => setDetailModalVisible(false)}>
              ÂÖ≥Èó≠
            </Button>,
            <Button 
              key="handle" 
              type="primary" 
              icon={<CheckOutlined />}
              onClick={() => handleNotification(selectedNotification.id)}
            >
              Ê†áËÆ∞‰∏∫Â∑≤Â§ÑÁêÜ
            </Button>
          ] : [
            <Button key="close" onClick={() => setDetailModalVisible(false)}>
              ÂÖ≥Èó≠
            </Button>
          ]
        }
        width={700}
      >
        {selectedNotification && (
          <div>
            <Descriptions bordered column={2}>
              <Descriptions.Item label="ÈÄöÁü•Áä∂ÊÄÅ" span={2}>
                <Tag color={getStatusColor(selectedNotification.notification_status)}>
                  {getStatusText(selectedNotification.notification_status)}
                </Tag>
              </Descriptions.Item>
              
              <Descriptions.Item label="ÈáçÂ§çÁ±ªÂûã" span={2}>
                <Space>
                  <span>{getDuplicateTypeInfo(selectedNotification.duplicate_type).icon}</span>
                  <span>{getDuplicateTypeInfo(selectedNotification.duplicate_type).label}</span>
                </Space>
              </Descriptions.Item>

              <Descriptions.Item label="Êñ∞Á∫øÁ¥¢ID">
                {selectedNotification.new_leadid}
              </Descriptions.Item>
              <Descriptions.Item label="ÂéüÁ∫øÁ¥¢ID">
                {selectedNotification.original_leadid || 'Êó†'}
              </Descriptions.Item>

              {selectedNotification.customer_phone && (
                <Descriptions.Item label="ÂÆ¢Êà∑ÊâãÊú∫Âè∑">
                  {selectedNotification.customer_phone}
                </Descriptions.Item>
              )}
              {selectedNotification.customer_wechat && (
                <Descriptions.Item label="ÂÆ¢Êà∑ÂæÆ‰ø°Âè∑">
                  {selectedNotification.customer_wechat}
                </Descriptions.Item>
              )}

              <Descriptions.Item label="ÂàõÂª∫Êó∂Èó¥">
                {dayjs(selectedNotification.created_at).format('YYYY-MM-DD HH:mm:ss')}
              </Descriptions.Item>
              {selectedNotification.handled_at && (
                <Descriptions.Item label="Â§ÑÁêÜÊó∂Èó¥">
                  {dayjs(selectedNotification.handled_at).format('YYYY-MM-DD HH:mm:ss')}
                </Descriptions.Item>
              )}
            </Descriptions>

            {/* Á∫øÁ¥¢ÂØπÊØî‰ø°ÊÅØ */}
            {selectedNotification.new_lead_info && selectedNotification.original_lead_info && (
              <div style={{ marginTop: '16px' }}>
                <Title level={5}>Á∫øÁ¥¢ÂØπÊØî</Title>
                <div style={{ display: 'flex', gap: '16px' }}>
                  <Card title="Êñ∞Á∫øÁ¥¢" size="small" style={{ flex: 1 }}>
                    <Descriptions size="small" column={1}>
                      <Descriptions.Item label="Êù•Ê∫ê">
                        {selectedNotification.new_lead_info.source || 'Êó†'}
                      </Descriptions.Item>
                      <Descriptions.Item label="Á±ªÂûã">
                        {selectedNotification.new_lead_info.leadtype || 'Êó†'}
                      </Descriptions.Item>
                      <Descriptions.Item label="ÂàõÂª∫Êó∂Èó¥">
                        {selectedNotification.new_lead_info.created_at 
                          ? dayjs(selectedNotification.new_lead_info.created_at).format('YYYY-MM-DD HH:mm')
                          : 'Êó†'
                        }
                      </Descriptions.Item>
                    </Descriptions>
                  </Card>
                  
                  <Card title="ÂéüÁ∫øÁ¥¢" size="small" style={{ flex: 1 }}>
                    <Descriptions size="small" column={1}>
                      <Descriptions.Item label="Êù•Ê∫ê">
                        {selectedNotification.original_lead_info.source || 'Êó†'}
                      </Descriptions.Item>
                      <Descriptions.Item label="Á±ªÂûã">
                        {selectedNotification.original_lead_info.leadtype || 'Êó†'}
                      </Descriptions.Item>
                      <Descriptions.Item label="ÂàõÂª∫Êó∂Èó¥">
                        {selectedNotification.original_lead_info.created_at 
                          ? dayjs(selectedNotification.original_lead_info.created_at).format('YYYY-MM-DD HH:mm')
                          : 'Êó†'
                        }
                      </Descriptions.Item>
                    </Descriptions>
                  </Card>
                </div>
              </div>
            )}

            <div style={{ marginTop: '16px', padding: '12px', backgroundColor: '#f6f8fa', borderRadius: '6px' }}>
              <Space>
                <InfoCircleOutlined style={{ color: '#1890ff' }} />
                <Text type="secondary">
                  ÈáçÂ§çÂÆ¢Êà∑Â∑≤Ëá™Âä®ÂàÜÈÖçÁªôÂéüÈîÄÂîÆ‰∫∫ÂëòÔºåËØ∑ÂèäÊó∂ËÅîÁ≥ªÂÆ¢Êà∑Á°ÆËÆ§ÈúÄÊ±ÇÂèòÂåñ„ÄÇ
                </Text>
              </Space>
            </div>
          </div>
        )}
      </Modal>
    </>
  );
}; 