# âš¡ ç«‹å³è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿå·²ä»æ‰¹é‡ä¿å­˜æ”¹ä¸ºç«‹å³ä¿å­˜æ¨¡å¼ï¼Œæä¾›æ›´ç›´è§‚çš„ç”¨æˆ·ä½“éªŒã€‚ç”¨æˆ·åœ¨è¾“å…¥æ¡†å¤±ç„¦æˆ–é€‰æ‹©å™¨é€‰ä¸­åï¼Œç³»ç»Ÿä¼šç«‹å³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. ğŸ¯ ç«‹å³ä¿å­˜ (Immediate Save)
- **å¤±ç„¦ä¿å­˜**ï¼šè¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨ä¿å­˜
- **é€‰æ‹©ä¿å­˜**ï¼šé€‰æ‹©å™¨é€‰ä¸­å€¼æ—¶ç«‹å³ä¿å­˜
- **å›è½¦ä¿å­˜**ï¼šè¾“å…¥æ¡†æŒ‰å›è½¦é”®æ—¶ä¿å­˜
- **æ— å»¶è¿Ÿ**ï¼šå»é™¤é˜²æŠ–æœºåˆ¶ï¼Œå“åº”æ›´å¿«

### 2. ğŸ”„ ä¹è§‚æ›´æ–° (Optimistic Updates)
- **UIç«‹å³å“åº”**ï¼šç”¨æˆ·è¾“å…¥åUIç«‹å³æ›´æ–°
- **åå°ä¿å­˜**ï¼šæ•°æ®åœ¨åå°å¼‚æ­¥ä¿å­˜åˆ°æ•°æ®åº“
- **æ™ºèƒ½å›æ»š**ï¼šä¿å­˜å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°åŸå€¼

### 3. ğŸ›¡ï¸ é”™è¯¯å¤„ç† (Error Handling)
- **è‡ªåŠ¨é‡è¯•**ï¼šä¿å­˜å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- **çŠ¶æ€åé¦ˆ**ï¼šå®æ—¶æ˜¾ç¤ºä¿å­˜çŠ¶æ€å’Œç»“æœ
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æœ¬åœ°æ•°æ®ä¸æ•°æ®åº“ä¸€è‡´

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒHooks

#### `useAutoSave`
```typescript
const autoSave = useAutoSave({
  maxRetries: 3,        // æœ€å¤§é‡è¯•3æ¬¡
  retryDelay: 1000      // é‡è¯•å»¶è¿Ÿ1ç§’
});
```

#### `useOptimizedLocalData`
```typescript
const optimizedLocalData = useOptimizedLocalData(data, {
  enableOptimisticUpdates: true,  // å¯ç”¨ä¹è§‚æ›´æ–°
  enableBatching: false,          // ç¦ç”¨æ‰¹é‡æ›´æ–°
  batchDelay: 0,                  // æ— å»¶è¿Ÿ
  maxBatchSize: 1                 // æ¯æ¬¡åªå¤„ç†1ä¸ªæ›´æ–°
});
```

### æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ â†’ ä¹è§‚æ›´æ–° â†’ ç«‹å³ä¿å­˜ â†’ æ•°æ®åº“
    â†“         â†“         â†“         â†“
  è¾“å…¥/é€‰æ‹©   UIæ›´æ–°    APIè°ƒç”¨   æŒä¹…åŒ–
```

## ğŸ“± ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```typescript
// 1. åˆå§‹åŒ–ç«‹å³è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ
const autoSave = useAutoSave({
  maxRetries: 3,        // æœ€å¤§é‡è¯•3æ¬¡
  retryDelay: 1000      // é‡è¯•å»¶è¿Ÿ1ç§’
});

// 2. å¤„ç†å­—æ®µç¼–è¾‘
const handleRowEdit = async (record: any, field: string, value: any) => {
  // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–°UI
  optimizedLocalData.updateField(record.id, field, value, {
    immediate: true,  // ç«‹å³æ›´æ–°UI
    queue: false      // ä¸åŠ å…¥é˜Ÿåˆ—ï¼Œç«‹å³ä¿å­˜
  });
  
  // ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
  const result = await autoSave.saveField(record.id, field, value, originalValue);
  
  if (!result.success) {
    // ä¿å­˜å¤±è´¥ï¼Œå›æ»šæœ¬åœ°æ•°æ®
    optimizedLocalData.rollbackField(record.id, field, originalValue);
    message.error('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
  } else if (!result.skipped) {
    // ä¿å­˜æˆåŠŸï¼ˆéè·³è¿‡ï¼‰
    message.success('ä¿å­˜æˆåŠŸ');
  }
};
```

### å­—æ®µç±»å‹å¤„ç†

#### 1. è¾“å…¥æ¡†å­—æ®µï¼ˆå¤±ç„¦ä¿å­˜ï¼‰
```typescript
// è·Ÿè¿›å¤‡æ³¨å­—æ®µ
<Input
  defaultValue={text || ''}
  onBlur={async (e) => {
    const val = (e.target as HTMLInputElement).value;
    const originalValue = record.followupresult || '';
    if (val !== originalValue) {
      onRowEdit(record, 'followupresult', val);
    }
  }}
  onPressEnter={async (e) => {
    const val = (e.target as HTMLInputElement).value;
    const originalValue = record.followupresult || '';
    if (val !== originalValue) {
      onRowEdit(record, 'followupresult', val);
    }
  }}
/>
```

#### 2. é€‰æ‹©å™¨å­—æ®µï¼ˆé€‰ä¸­ä¿å­˜ï¼‰
```typescript
// é¢„çº¦ç¤¾åŒºå­—æ®µ
<Select 
  value={text} 
  options={communityEnum} 
  onChange={val => onRowEdit(record, 'scheduledcommunity', val)} 
/>
```

#### 3. æ•°å­—è¾“å…¥æ¡†ï¼ˆå˜åŒ–ä¿å­˜ï¼‰
```typescript
// ç”¨æˆ·é¢„ç®—å­—æ®µ
<InputNumber
  defaultValue={record.userbudget === '' ? undefined : Number(record.userbudget)}
  onChange={(value) => {
    const val = value === null ? '' : String(value);
    onRowEdit(record, 'userbudget', val);
  }}
/>
```

#### 4. æ—¥æœŸé€‰æ‹©å™¨ï¼ˆé€‰æ‹©ä¿å­˜ï¼‰
```typescript
// å…¥ä½æ—¥æœŸå­—æ®µ
<DatePicker
  value={text ? dayjs(text) : undefined}
  onChange={async v => {
    if (v) {
      const val = v.format('YYYY-MM-DD') + ' 00:00:00';
      onRowEdit(record, 'moveintime', val);
    }
  }}
/>
```

## ğŸ”§ é…ç½®é€‰é¡¹

### AutoSaveé…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `maxRetries` | number | 3 | æœ€å¤§é‡è¯•æ¬¡æ•° |
| `retryDelay` | number | 1000 | é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ |

### LocalDataé…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enableOptimisticUpdates` | boolean | true | æ˜¯å¦å¯ç”¨ä¹è§‚æ›´æ–° |
| `enableBatching` | boolean | false | æ˜¯å¦å¯ç”¨æ‰¹é‡æ›´æ–° |
| `batchDelay` | number | 0 | æ‰¹é‡æ›´æ–°å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ |
| `maxBatchSize` | number | 1 | æœ€å¤§æ‰¹é‡å¤§å° |

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### 1. å“åº”é€Ÿåº¦
- **UIå“åº”**ï¼š< 16msï¼ˆ60fpsï¼‰
- **ä¿å­˜å»¶è¿Ÿ**ï¼š0msï¼ˆç«‹å³ä¿å­˜ï¼‰
- **ç½‘ç»œä¼˜åŒ–**ï¼šæ¯æ¬¡ç¼–è¾‘éƒ½ç«‹å³ä¿å­˜

### 2. èµ„æºåˆ©ç”¨
- **å†…å­˜ä¼˜åŒ–**ï¼šä½¿ç”¨refé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- **CPUä¼˜åŒ–**ï¼šç«‹å³æ›´æ–°ï¼Œæ— æ‰¹é‡å¤„ç†å¼€é”€
- **ç½‘ç»œä¼˜åŒ–**ï¼šå®æ—¶ä¿å­˜ï¼Œæ— é˜Ÿåˆ—å»¶è¿Ÿ

### 3. ç”¨æˆ·ä½“éªŒ
- **å³æ—¶åé¦ˆ**ï¼šè¾“å…¥åç«‹å³çœ‹åˆ°å˜åŒ–
- **å®æ—¶ä¿å­˜**ï¼šæ— éœ€ç­‰å¾…ï¼Œæ•°æ®å®æ—¶åŒæ­¥
- **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨é‡è¯•å’Œå›æ»šæœºåˆ¶

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§
- ä¹è§‚æ›´æ–°å¯èƒ½å¯¼è‡´ä¸´æ—¶æ•°æ®ä¸ä¸€è‡´
- ä¿å­˜å¤±è´¥æ—¶ä¼šè‡ªåŠ¨å›æ»šåˆ°åŸå€¼
- æ”¯æŒæ‰‹åŠ¨å›æ»šå’Œé”™è¯¯æ¢å¤

### 2. ç½‘ç»œä¼˜åŒ–
- æ¯æ¬¡ç¼–è¾‘éƒ½ä¼šå‘é€è¯·æ±‚
- å»ºè®®åœ¨ç½‘ç»œè‰¯å¥½æ—¶ä½¿ç”¨
- æ”¯æŒè‡ªåŠ¨é‡è¯•å¤„ç†ç½‘ç»œå¼‚å¸¸

### 3. æ€§èƒ½è€ƒè™‘
- é€‚åˆç¼–è¾‘é¢‘ç‡ä¸é«˜çš„åœºæ™¯
- å¤§é‡å¹¶å‘ç¼–è¾‘å¯èƒ½å¢åŠ æœåŠ¡å™¨å‹åŠ›
- å»ºè®®åˆç†è®¾ç½®é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿ

## ğŸ”® ä½¿ç”¨åœºæ™¯

### 1. é€‚åˆçš„åœºæ™¯
- **è¡¨å•ç¼–è¾‘**ï¼šç”¨æˆ·éœ€è¦ç«‹å³çœ‹åˆ°è¾“å…¥ç»“æœ
- **å®æ—¶åä½œ**ï¼šå¤šäººåŒæ—¶ç¼–è¾‘åŒä¸€æ•°æ®
- **å…³é”®æ“ä½œ**ï¼šéœ€è¦ç«‹å³ä¿å­˜çš„é‡è¦æ•°æ®
- **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šè¿½æ±‚æµç•…çš„ç¼–è¾‘ä½“éªŒ

### 2. æ³¨æ„äº‹é¡¹
- **ç½‘ç»œç¯å¢ƒ**ï¼šç¡®ä¿ç½‘ç»œç¨³å®š
- **å¹¶å‘ç¼–è¾‘**ï¼šé¿å…å¤šäººåŒæ—¶ç¼–è¾‘åŒä¸€è®°å½•
- **æ•°æ®é‡**ï¼šå¤§é‡æ•°æ®ç¼–è¾‘æ—¶è€ƒè™‘æ€§èƒ½å½±å“

## ğŸ“š å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | æ‰¹é‡ä¿å­˜ | ç«‹å³ä¿å­˜ |
|------|----------|----------|
| **å“åº”é€Ÿåº¦** | 500mså»¶è¿Ÿ | ç«‹å³å“åº” |
| **ç½‘ç»œè¯·æ±‚** | æ‰¹é‡å‡å°‘ | æ¯æ¬¡ç¼–è¾‘ |
| **ç”¨æˆ·ä½“éªŒ** | å»¶è¿Ÿåé¦ˆ | å³æ—¶åé¦ˆ |
| **æœåŠ¡å™¨å‹åŠ›** | è¾ƒä½ | è¾ƒé«˜ |
| **æ•°æ®ä¸€è‡´æ€§** | æ‰¹é‡å¤„ç† | å®æ—¶åŒæ­¥ |

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å­—æ®µé…ç½®
- **è¾“å…¥æ¡†**ï¼šä½¿ç”¨`onBlur`å’Œ`onPressEnter`äº‹ä»¶
- **é€‰æ‹©å™¨**ï¼šä½¿ç”¨`onChange`äº‹ä»¶
- **æ•°å­—è¾“å…¥**ï¼šä½¿ç”¨`onChange`äº‹ä»¶
- **æ—¥æœŸé€‰æ‹©**ï¼šä½¿ç”¨`onChange`äº‹ä»¶

### 2. é”™è¯¯å¤„ç†
- å®ç°é€‚å½“çš„é”™è¯¯æç¤º
- è®¾ç½®åˆç†çš„é‡è¯•æ¬¡æ•°
- æä¾›æ‰‹åŠ¨é‡è¯•é€‰é¡¹
- è®°å½•ä¿å­˜å¤±è´¥æ—¥å¿—

### 3. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®é‡è¯•å»¶è¿Ÿ
- é¿å…ä¸å¿…è¦çš„ä¹è§‚æ›´æ–°
- ç›‘æ§ä¿å­˜æˆåŠŸç‡
- ä¼˜åŒ–ç½‘ç»œè¯·æ±‚

è¿™ä¸ªç«‹å³è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿä¸ºç”¨æˆ·æä¾›äº†æ›´ç›´è§‚ã€æ›´æµç•…çš„ç¼–è¾‘ä½“éªŒï¼Œç‰¹åˆ«é€‚åˆéœ€è¦å®æ—¶åé¦ˆçš„åœºæ™¯ã€‚
