<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†åˆ†é…ç³»ç»Ÿ - Supabaseæ•°æ®æµ‹è¯•</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .content {
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .test-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }
        .test-body {
            padding: 15px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
        }
        .card h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç§¯åˆ†åˆ†é…ç³»ç»Ÿ - Supabaseæ•°æ®æµ‹è¯•</h1>
            <p>è¿æ¥Supabaseè¿›è¡Œç§¯åˆ†åˆ†é…ç³»ç»ŸåŠŸèƒ½æµ‹è¯•</p>
        </div>
        
        <div class="content">
            <!-- è¿æ¥æµ‹è¯• -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ”— è¿æ¥æµ‹è¯•
                </div>
                <div class="test-body">
                    <button class="button" onclick="testConnection()">æµ‹è¯•Supabaseè¿æ¥</button>
                    <div id="connection-status"></div>
                    <div id="connection-log" class="log-area"></div>
                </div>
            </div>

            <!-- ç³»ç»Ÿç»„ä»¶æ£€æŸ¥ -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ” ç³»ç»Ÿç»„ä»¶æ£€æŸ¥
                </div>
                <div class="test-body">
                    <button class="button" onclick="checkSystemComponents()">æ£€æŸ¥ç³»ç»Ÿç»„ä»¶</button>
                    <div id="components-status"></div>
                    <div id="components-log" class="log-area"></div>
                </div>
            </div>

            <!-- æµ‹è¯•ç”¨æˆ·ç®¡ç† -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ‘¥ æµ‹è¯•ç”¨æˆ·ç®¡ç†
                </div>
                <div class="test-body">
                    <button class="button" onclick="manageTestUsers()">åˆ›å»ºæµ‹è¯•ç”¨æˆ·</button>
                    <button class="button danger" onclick="cleanupTestUsers()">æ¸…ç†æµ‹è¯•ç”¨æˆ·</button>
                    <div id="users-status"></div>
                    <div id="users-log" class="log-area"></div>
                </div>
            </div>

            <!-- ç§¯åˆ†æˆæœ¬è®¡ç®—æµ‹è¯• -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ’° ç§¯åˆ†æˆæœ¬è®¡ç®—æµ‹è¯•
                </div>
                <div class="test-body">
                    <button class="button" onclick="testPointsCostCalculation()">æµ‹è¯•ç§¯åˆ†æˆæœ¬è®¡ç®—</button>
                    <div id="cost-status"></div>
                    <div id="cost-log" class="log-area"></div>
                </div>
            </div>

            <!-- ç§¯åˆ†åˆ†é…é€»è¾‘æµ‹è¯• -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ¯ ç§¯åˆ†åˆ†é…é€»è¾‘æµ‹è¯•
                </div>
                <div class="test-body">
                    <button class="button" onclick="testPointsAllocation()">æµ‹è¯•ç§¯åˆ†åˆ†é…é€»è¾‘</button>
                    <div id="allocation-status"></div>
                    <div id="allocation-log" class="log-area"></div>
                </div>
            </div>

            <!-- æµ‹è¯•çº¿ç´¢åˆ›å»º -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ“ æµ‹è¯•çº¿ç´¢åˆ›å»º
                </div>
                <div class="test-body">
                    <button class="button" onclick="createTestLeads()">åˆ›å»ºæµ‹è¯•çº¿ç´¢</button>
                    <button class="button danger" onclick="cleanupTestLeads()">æ¸…ç†æµ‹è¯•çº¿ç´¢</button>
                    <div id="leads-status"></div>
                    <div id="leads-log" class="log-area"></div>
                </div>
            </div>

            <!-- æŸ¥çœ‹æµ‹è¯•ç»“æœ -->
            <div class="test-section">
                <div class="test-header">
                    ğŸ“Š æŸ¥çœ‹æµ‹è¯•ç»“æœ
                </div>
                <div class="test-body">
                    <button class="button" onclick="viewTestResults()">æŸ¥çœ‹æµ‹è¯•ç»“æœ</button>
                    <div id="results-status"></div>
                    <div id="results-log" class="log-area"></div>
                </div>
            </div>

            <!-- ä¸€é”®æµ‹è¯• -->
            <div class="test-section">
                <div class="test-header">
                    ğŸš€ ä¸€é”®å®Œæ•´æµ‹è¯•
                </div>
                <div class="test-body">
                    <button class="button success" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                    <button class="button danger" onclick="cleanupAllTestData()">æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®</button>
                    <div id="all-tests-status"></div>
                    <div id="all-tests-log" class="log-area"></div>
                </div>
            </div>

            <!-- å®æ—¶çŠ¶æ€ -->
            <div class="grid">
                <div class="card">
                    <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</h3>
                    <div id="system-status">
                        <p>ç­‰å¾…æµ‹è¯•...</p>
                    </div>
                </div>
                <div class="card">
                    <h3>ğŸ”§ å¿«é€Ÿæ“ä½œ</h3>
                    <button class="button" onclick="checkDatabaseTables()">æ£€æŸ¥æ•°æ®åº“è¡¨</button>
                    <button class="button" onclick="checkFunctions()">æ£€æŸ¥å‡½æ•°</button>
                    <button class="button" onclick="checkTriggers()">æ£€æŸ¥è§¦å‘å™¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabaseé…ç½®
        const supabaseUrl = 'https://wteqgprgiylmxzszcnws.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0ZXFncHJnaXlsbXh6c3pjbndzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNzc5ODEsImV4cCI6MjA2Njc1Mzk4MX0.VpS4zrfPjA8e'

        // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey)

        // æ—¥å¿—å‡½æ•°
        function logToArea(areaId, message) {
            const area = document.getElementById(areaId)
            if (area) {
                area.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n'
                area.scrollTop = area.scrollHeight
            }
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId)
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`
            }
        }

        // 1. è¿æ¥æµ‹è¯•
        async function testConnection() {
            logToArea('connection-log', 'ğŸ”— å¼€å§‹æµ‹è¯•Supabaseè¿æ¥...')
            
            try {
                const { data, error } = await supabase.from('users_profile').select('count').limit(1)
                
                if (error) {
                    logToArea('connection-log', 'âŒ è¿æ¥å¤±è´¥: ' + error.message)
                    setStatus('connection-status', 'è¿æ¥å¤±è´¥: ' + error.message, 'error')
                } else {
                    logToArea('connection-log', 'âœ… Supabaseè¿æ¥æˆåŠŸ')
                    setStatus('connection-status', 'Supabaseè¿æ¥æˆåŠŸ', 'success')
                }
            } catch (error) {
                logToArea('connection-log', 'âŒ è¿æ¥å¼‚å¸¸: ' + error.message)
                setStatus('connection-status', 'è¿æ¥å¼‚å¸¸: ' + error.message, 'error')
            }
        }

        // 2. ç³»ç»Ÿç»„ä»¶æ£€æŸ¥
        async function checkSystemComponents() {
            logToArea('components-log', 'ğŸ” å¼€å§‹æ£€æŸ¥ç§¯åˆ†åˆ†é…ç³»ç»Ÿç»„ä»¶...')
            
            const checks = []
            
            // æ£€æŸ¥ç§¯åˆ†åˆ†é…æšä¸¾
            try {
                const { data: enumData, error: enumError } = await supabase.rpc('get_enum_values', { enum_name: 'allocation_method' })
                if (enumError) {
                    checks.push({ name: 'ç§¯åˆ†åˆ†é…æšä¸¾', status: 'âŒ', error: enumError.message })
                } else {
                    const hasPoints = enumData && enumData.includes('points')
                    checks.push({ 
                        name: 'ç§¯åˆ†åˆ†é…æšä¸¾', 
                        status: hasPoints ? 'âœ…' : 'âŒ', 
                        details: hasPoints ? 'pointsæšä¸¾å­˜åœ¨' : 'pointsæšä¸¾ä¸å­˜åœ¨'
                    })
                }
            } catch (error) {
                checks.push({ name: 'ç§¯åˆ†åˆ†é…æšä¸¾', status: 'âŒ', error: error.message })
            }
            
            // æ£€æŸ¥ç§¯åˆ†æˆæœ¬è¡¨
            try {
                const { data: costData, error: costError } = await supabase.from('lead_points_cost').select('count').limit(1)
                checks.push({ 
                    name: 'ç§¯åˆ†æˆæœ¬è¡¨', 
                    status: costError ? 'âŒ' : 'âœ…', 
                    details: costError ? costError.message : 'è¡¨å­˜åœ¨'
                })
            } catch (error) {
                checks.push({ name: 'ç§¯åˆ†æˆæœ¬è¡¨', status: 'âŒ', error: error.message })
            }
            
            // æ£€æŸ¥åˆ†é…æ—¥å¿—ç§¯åˆ†å­—æ®µ
            try {
                const { data: logData, error: logError } = await supabase.from('simple_allocation_logs').select('points_cost').limit(1)
                checks.push({ 
                    name: 'åˆ†é…æ—¥å¿—ç§¯åˆ†å­—æ®µ', 
                    status: logError ? 'âŒ' : 'âœ…', 
                    details: logError ? logError.message : 'å­—æ®µå­˜åœ¨'
                })
            } catch (error) {
                checks.push({ name: 'åˆ†é…æ—¥å¿—ç§¯åˆ†å­—æ®µ', status: 'âŒ', error: error.message })
            }
            
            // è¾“å‡ºæ£€æŸ¥ç»“æœ
            checks.forEach(check => {
                const message = `${check.status} ${check.name}: ${check.details || check.error}`
                logToArea('components-log', message)
            })
            
            const successCount = checks.filter(c => c.status === 'âœ…').length
            const totalCount = checks.length
            
            if (successCount === totalCount) {
                setStatus('components-status', `æ‰€æœ‰ç»„ä»¶æ£€æŸ¥é€šè¿‡ (${successCount}/${totalCount})`, 'success')
            } else {
                setStatus('components-status', `éƒ¨åˆ†ç»„ä»¶æ£€æŸ¥å¤±è´¥ (${successCount}/${totalCount})`, 'error')
            }
        }

        // 3. æµ‹è¯•ç”¨æˆ·ç®¡ç†
        async function manageTestUsers() {
            logToArea('users-log', 'ğŸ‘¥ å¼€å§‹ç®¡ç†æµ‹è¯•ç”¨æˆ·...')
            
            const testUsers = [
                { id: 1001, name: 'æµ‹è¯•ç”¨æˆ·A', email: 'test_a@example.com', phone: '13800138001' },
                { id: 1002, name: 'æµ‹è¯•ç”¨æˆ·B', email: 'test_b@example.com', phone: '13800138002' },
                { id: 1003, name: 'æµ‹è¯•ç”¨æˆ·C', email: 'test_c@example.com', phone: '13800138003' }
            ]
            
            for (const user of testUsers) {
                try {
                    const { data: existingUser } = await supabase
                        .from('users_profile')
                        .select('id')
                        .eq('id', user.id)
                        .single()
                    
                    if (!existingUser) {
                        const { error: insertError } = await supabase
                            .from('users_profile')
                            .insert({
                                id: user.id,
                                name: user.name,
                                email: user.email,
                                phone: user.phone,
                                status: 'active',
                                organization_id: 1,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                        
                        if (insertError) {
                            logToArea('users-log', `âŒ åˆ›å»ºç”¨æˆ·${user.name}å¤±è´¥: ${insertError.message}`)
                        } else {
                            logToArea('users-log', `âœ… åˆ›å»ºç”¨æˆ·${user.name}æˆåŠŸ`)
                        }
                    } else {
                        logToArea('users-log', `â„¹ï¸ ç”¨æˆ·${user.name}å·²å­˜åœ¨`)
                    }
                } catch (error) {
                    logToArea('users-log', `âŒ å¤„ç†ç”¨æˆ·${user.name}æ—¶å‡ºé”™: ${error.message}`)
                }
            }
            
            // åˆ›å»ºç§¯åˆ†é’±åŒ…
            const walletData = [
                { user_id: 1001, total_points: 100 },
                { user_id: 1002, total_points: 50 },
                { user_id: 1003, total_points: 200 }
            ]
            
            for (const wallet of walletData) {
                try {
                    const { data: existingWallet } = await supabase
                        .from('user_points_wallet')
                        .select('user_id')
                        .eq('user_id', wallet.user_id)
                        .single()
                    
                    if (!existingWallet) {
                        const { error: walletError } = await supabase
                            .from('user_points_wallet')
                            .insert({
                                user_id: wallet.user_id,
                                total_points: wallet.total_points,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                        
                        if (walletError) {
                            logToArea('users-log', `âŒ åˆ›å»ºé’±åŒ…å¤±è´¥: ${walletError.message}`)
                        } else {
                            logToArea('users-log', `âœ… åˆ›å»ºç”¨æˆ·${wallet.user_id}é’±åŒ…æˆåŠŸï¼Œç§¯åˆ†: ${wallet.total_points}`)
                        }
                    } else {
                        logToArea('users-log', `â„¹ï¸ ç”¨æˆ·${wallet.user_id}é’±åŒ…å·²å­˜åœ¨`)
                    }
                } catch (error) {
                    logToArea('users-log', `âŒ å¤„ç†é’±åŒ…æ—¶å‡ºé”™: ${error.message}`)
                }
            }
            
            setStatus('users-status', 'æµ‹è¯•ç”¨æˆ·ç®¡ç†å®Œæˆ', 'success')
        }

        // 4. ç§¯åˆ†æˆæœ¬è®¡ç®—æµ‹è¯•
        async function testPointsCostCalculation() {
            logToArea('cost-log', 'ğŸ’° å¼€å§‹æµ‹è¯•ç§¯åˆ†æˆæœ¬è®¡ç®—...')
            
            const testCases = [
                {
                    name: 'åŸºç¡€æˆæœ¬æµ‹è¯•',
                    source: 'æŠ–éŸ³',
                    leadtype: 'æ„å‘å®¢æˆ·',
                    campaignname: null,
                    unitname: null,
                    remark: null
                },
                {
                    name: 'åŠ¨æ€è°ƒæ•´æµ‹è¯•',
                    source: 'å¾®ä¿¡',
                    leadtype: 'å‡†å®¢æˆ·',
                    campaignname: 'å­¦åŒºæˆ¿å¹¿å‘Š',
                    unitname: 'å­¦åŒºå•å…ƒ',
                    remark: 'å­¦åŒºæˆ¿[COMMUNITY:æµ¦æ±Ÿå…¬å›­ç¤¾åŒº]'
                },
                {
                    name: 'é«˜ä»·å€¼çº¿ç´¢æµ‹è¯•',
                    source: 'æŠ–éŸ³',
                    leadtype: 'æ„å‘å®¢æˆ·',
                    campaignname: 'é«˜ç«¯åˆ«å¢…å¹¿å‘Š',
                    unitname: 'åˆ«å¢…å•å…ƒ',
                    remark: 'é«˜ç«¯åˆ«å¢…[COMMUNITY:æµ¦æ±Ÿå…¬å›­ç¤¾åŒº]'
                }
            ]
            
            for (const testCase of testCases) {
                try {
                    const { data, error } = await supabase.rpc('calculate_lead_points_cost', {
                        p_source: testCase.source,
                        p_leadtype: testCase.leadtype,
                        p_campaignname: testCase.campaignname,
                        p_unitname: testCase.unitname,
                        p_remark: testCase.remark
                    })
                    
                    if (error) {
                        logToArea('cost-log', `âŒ ${testCase.name}å¤±è´¥: ${error.message}`)
                    } else {
                        logToArea('cost-log', `âœ… ${testCase.name}: ${JSON.stringify(data, null, 2)}`)
                    }
                } catch (error) {
                    logToArea('cost-log', `âŒ ${testCase.name}å¼‚å¸¸: ${error.message}`)
                }
            }
            
            setStatus('cost-status', 'ç§¯åˆ†æˆæœ¬è®¡ç®—æµ‹è¯•å®Œæˆ', 'success')
        }

        // 5. ç§¯åˆ†åˆ†é…é€»è¾‘æµ‹è¯•
        async function testPointsAllocation() {
            logToArea('allocation-log', 'ğŸ¯ å¼€å§‹æµ‹è¯•ç§¯åˆ†åˆ†é…é€»è¾‘...')
            
            try {
                const { data, error } = await supabase.rpc('allocate_from_users', {
                    user_list: [1001, 1002, 1003],
                    method: 'points',
                    p_required_points: 50
                })
                
                if (error) {
                    logToArea('allocation-log', 'âŒ ç§¯åˆ†åˆ†é…æµ‹è¯•å¤±è´¥: ' + error.message)
                    setStatus('allocation-status', 'ç§¯åˆ†åˆ†é…æµ‹è¯•å¤±è´¥: ' + error.message, 'error')
                } else {
                    logToArea('allocation-log', 'âœ… ç§¯åˆ†åˆ†é…æµ‹è¯•æˆåŠŸï¼Œé€‰ä¸­ç”¨æˆ·ID: ' + data)
                    setStatus('allocation-status', 'ç§¯åˆ†åˆ†é…æµ‹è¯•æˆåŠŸï¼Œé€‰ä¸­ç”¨æˆ·ID: ' + data, 'success')
                }
            } catch (error) {
                logToArea('allocation-log', 'âŒ ç§¯åˆ†åˆ†é…æµ‹è¯•å¼‚å¸¸: ' + error.message)
                setStatus('allocation-status', 'ç§¯åˆ†åˆ†é…æµ‹è¯•å¼‚å¸¸: ' + error.message, 'error')
            }
        }

        // 6. åˆ›å»ºæµ‹è¯•çº¿ç´¢
        async function createTestLeads() {
            logToArea('leads-log', 'ğŸ“ å¼€å§‹åˆ›å»ºæµ‹è¯•çº¿ç´¢...')
            
            const testLeads = [
                {
                    name: 'é«˜ä»·å€¼çº¿ç´¢',
                    source: 'æŠ–éŸ³',
                    leadtype: 'æ„å‘å®¢æˆ·',
                    campaignname: 'é«˜ç«¯åˆ«å¢…å¹¿å‘Š',
                    unitname: 'åˆ«å¢…å•å…ƒ',
                    remark: 'é«˜ç«¯åˆ«å¢…[COMMUNITY:æµ¦æ±Ÿå…¬å›­ç¤¾åŒº]',
                    phone: '13900139001',
                    wechat: 'test_high_001'
                },
                {
                    name: 'æ™®é€šçº¿ç´¢',
                    source: 'å¾®ä¿¡',
                    leadtype: 'å‡†å®¢æˆ·',
                    campaignname: 'æ™®é€šå¹¿å‘Š',
                    unitname: 'æ™®é€šå•å…ƒ',
                    remark: 'æ™®é€šçº¿ç´¢[COMMUNITY:æµ¦æ±Ÿå…¬å›­ç¤¾åŒº]',
                    phone: '13900139002',
                    wechat: 'test_normal_002'
                },
                {
                    name: 'ä½ä»·å€¼çº¿ç´¢',
                    source: 'ç™¾åº¦',
                    leadtype: 'æ½œåœ¨å®¢æˆ·',
                    campaignname: 'åŸºç¡€å¹¿å‘Š',
                    unitname: 'åŸºç¡€å•å…ƒ',
                    remark: 'åŸºç¡€çº¿ç´¢[COMMUNITY:æµ¦æ±Ÿå…¬å›­ç¤¾åŒº]',
                    phone: '13900139003',
                    wechat: 'test_low_003'
                }
            ]
            
            for (const lead of testLeads) {
                try {
                    const leadid = `JS_TEST_${lead.name}_${Date.now()}`
                    
                    const { error } = await supabase
                        .from('leads')
                        .insert({
                            leadid: leadid,
                            source: lead.source,
                            leadtype: lead.leadtype,
                            campaignname: lead.campaignname,
                            unitname: lead.unitname,
                            remark: lead.remark,
                            phone: lead.phone,
                            wechat: lead.wechat,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                    
                    if (error) {
                        logToArea('leads-log', `âŒ åˆ›å»º${lead.name}å¤±è´¥: ${error.message}`)
                    } else {
                        logToArea('leads-log', `âœ… åˆ›å»º${lead.name}æˆåŠŸï¼ŒID: ${leadid}`)
                    }
                } catch (error) {
                    logToArea('leads-log', `âŒ åˆ›å»º${lead.name}å¼‚å¸¸: ${error.message}`)
                }
            }
            
            setStatus('leads-status', 'æµ‹è¯•çº¿ç´¢åˆ›å»ºå®Œæˆ', 'success')
        }

        // 7. æŸ¥çœ‹æµ‹è¯•ç»“æœ
        async function viewTestResults() {
            logToArea('results-log', 'ğŸ“Š å¼€å§‹æŸ¥çœ‹æµ‹è¯•ç»“æœ...')
            
            // æŸ¥çœ‹åˆ†é…æ—¥å¿—
            try {
                const { data: allocationLogs, error: logError } = await supabase
                    .from('simple_allocation_logs')
                    .select('*')
                    .like('leadid', 'JS_TEST_%')
                    .order('created_at', { ascending: false })
                
                if (logError) {
                    logToArea('results-log', 'âŒ è·å–åˆ†é…æ—¥å¿—å¤±è´¥: ' + logError.message)
                } else {
                    logToArea('results-log', 'ğŸ“‹ åˆ†é…æ—¥å¿—: ' + JSON.stringify(allocationLogs, null, 2))
                }
            } catch (error) {
                logToArea('results-log', 'âŒ è·å–åˆ†é…æ—¥å¿—å¼‚å¸¸: ' + error.message)
            }
            
            // æŸ¥çœ‹ç§¯åˆ†äº¤æ˜“
            try {
                const { data: transactions, error: transError } = await supabase
                    .from('user_points_transactions')
                    .select('*')
                    .like('description', '%JS_TEST_%')
                    .order('created_at', { ascending: false })
                
                if (transError) {
                    logToArea('results-log', 'âŒ è·å–ç§¯åˆ†äº¤æ˜“å¤±è´¥: ' + transError.message)
                } else {
                    logToArea('results-log', 'ğŸ’° ç§¯åˆ†äº¤æ˜“: ' + JSON.stringify(transactions, null, 2))
                }
            } catch (error) {
                logToArea('results-log', 'âŒ è·å–ç§¯åˆ†äº¤æ˜“å¼‚å¸¸: ' + error.message)
            }
            
            // æŸ¥çœ‹followups
            try {
                const { data: followups, error: followError } = await supabase
                    .from('followups')
                    .select('*')
                    .like('leadid', 'JS_TEST_%')
                    .order('created_at', { ascending: false })
                
                if (followError) {
                    logToArea('results-log', 'âŒ è·å–followupså¤±è´¥: ' + followError.message)
                } else {
                    logToArea('results-log', 'ğŸ“ Followups: ' + JSON.stringify(followups, null, 2))
                }
            } catch (error) {
                logToArea('results-log', 'âŒ è·å–followupså¼‚å¸¸: ' + error.message)
            }
            
            setStatus('results-status', 'æµ‹è¯•ç»“æœæŸ¥çœ‹å®Œæˆ', 'success')
        }

        // 8. æ¸…ç†å‡½æ•°
        async function cleanupTestUsers() {
            logToArea('users-log', 'ğŸ§¹ å¼€å§‹æ¸…ç†æµ‹è¯•ç”¨æˆ·...')
            
            try {
                const { error } = await supabase
                    .from('users_profile')
                    .delete()
                    .in('id', [1001, 1002, 1003])
                
                if (error) {
                    logToArea('users-log', 'âŒ æ¸…ç†æµ‹è¯•ç”¨æˆ·å¤±è´¥: ' + error.message)
                } else {
                    logToArea('users-log', 'âœ… æ¸…ç†æµ‹è¯•ç”¨æˆ·æˆåŠŸ')
                }
            } catch (error) {
                logToArea('users-log', 'âŒ æ¸…ç†æµ‹è¯•ç”¨æˆ·å¼‚å¸¸: ' + error.message)
            }
        }

        async function cleanupTestLeads() {
            logToArea('leads-log', 'ğŸ§¹ å¼€å§‹æ¸…ç†æµ‹è¯•çº¿ç´¢...')
            
            try {
                const { error } = await supabase
                    .from('leads')
                    .delete()
                    .like('leadid', 'JS_TEST_%')
                
                if (error) {
                    logToArea('leads-log', 'âŒ æ¸…ç†æµ‹è¯•çº¿ç´¢å¤±è´¥: ' + error.message)
                } else {
                    logToArea('leads-log', 'âœ… æ¸…ç†æµ‹è¯•çº¿ç´¢æˆåŠŸ')
                }
            } catch (error) {
                logToArea('leads-log', 'âŒ æ¸…ç†æµ‹è¯•çº¿ç´¢å¼‚å¸¸: ' + error.message)
            }
        }

        async function cleanupAllTestData() {
            logToArea('all-tests-log', 'ğŸ§¹ å¼€å§‹æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®...')
            
            try {
                // æ¸…ç†æµ‹è¯•çº¿ç´¢
                await supabase.from('leads').delete().like('leadid', 'JS_TEST_%')
                logToArea('all-tests-log', 'âœ… æ¸…ç†æµ‹è¯•çº¿ç´¢æˆåŠŸ')
                
                // æ¸…ç†æµ‹è¯•åˆ†é…æ—¥å¿—
                await supabase.from('simple_allocation_logs').delete().like('leadid', 'JS_TEST_%')
                logToArea('all-tests-log', 'âœ… æ¸…ç†æµ‹è¯•åˆ†é…æ—¥å¿—æˆåŠŸ')
                
                // æ¸…ç†æµ‹è¯•ç§¯åˆ†äº¤æ˜“
                await supabase.from('user_points_transactions').delete().like('description', '%JS_TEST_%')
                logToArea('all-tests-log', 'âœ… æ¸…ç†æµ‹è¯•ç§¯åˆ†äº¤æ˜“æˆåŠŸ')
                
                setStatus('all-tests-status', 'æ‰€æœ‰æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ', 'success')
            } catch (error) {
                logToArea('all-tests-log', 'âŒ æ¸…ç†æµ‹è¯•æ•°æ®å¼‚å¸¸: ' + error.message)
                setStatus('all-tests-status', 'æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'error')
            }
        }

        // 9. ä¸€é”®å®Œæ•´æµ‹è¯•
        async function runAllTests() {
            logToArea('all-tests-log', 'ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...\n')
            
            // 1. æµ‹è¯•è¿æ¥
            await testConnection()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            // 2. æ£€æŸ¥ç³»ç»Ÿç»„ä»¶
            await checkSystemComponents()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            // 3. ç®¡ç†æµ‹è¯•ç”¨æˆ·
            await manageTestUsers()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            // 4. æµ‹è¯•ç§¯åˆ†æˆæœ¬è®¡ç®—
            await testPointsCostCalculation()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            // 5. æµ‹è¯•ç§¯åˆ†åˆ†é…é€»è¾‘
            await testPointsAllocation()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            // 6. åˆ›å»ºæµ‹è¯•çº¿ç´¢
            await createTestLeads()
            await new Promise(resolve => setTimeout(resolve, 3000))
            
            // 7. æŸ¥çœ‹æµ‹è¯•ç»“æœ
            await viewTestResults()
            
            logToArea('all-tests-log', '\nâœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼')
            setStatus('all-tests-status', 'æ‰€æœ‰æµ‹è¯•å®Œæˆ', 'success')
        }

        // 10. å¿«é€Ÿæ£€æŸ¥å‡½æ•°
        async function checkDatabaseTables() {
            logToArea('all-tests-log', 'ğŸ”§ æ£€æŸ¥æ•°æ®åº“è¡¨...')
            
            const tables = ['users_profile', 'user_points_wallet', 'leads', 'simple_allocation_logs', 'user_points_transactions', 'followups', 'lead_points_cost']
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('count').limit(1)
                    if (error) {
                        logToArea('all-tests-log', `âŒ è¡¨ ${table} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${error.message}`)
                    } else {
                        logToArea('all-tests-log', `âœ… è¡¨ ${table} å­˜åœ¨`)
                    }
                } catch (error) {
                    logToArea('all-tests-log', `âŒ æ£€æŸ¥è¡¨ ${table} å¼‚å¸¸: ${error.message}`)
                }
            }
        }

        async function checkFunctions() {
            logToArea('all-tests-log', 'ğŸ”§ æ£€æŸ¥å‡½æ•°...')
            
            const functions = ['calculate_lead_points_cost', 'allocate_from_users', 'process_points_deduction']
            
            for (const func of functions) {
                try {
                    const { data, error } = await supabase.rpc(func, {})
                    if (error && error.message.includes('function')) {
                        logToArea('all-tests-log', `âŒ å‡½æ•° ${func} ä¸å­˜åœ¨: ${error.message}`)
                    } else {
                        logToArea('all-tests-log', `âœ… å‡½æ•° ${func} å­˜åœ¨`)
                    }
                } catch (error) {
                    logToArea('all-tests-log', `âœ… å‡½æ•° ${func} å­˜åœ¨ (å‚æ•°é”™è¯¯æ˜¯æ­£å¸¸çš„)`)
                }
            }
        }

        async function checkTriggers() {
            logToArea('all-tests-log', 'ğŸ”§ æ£€æŸ¥è§¦å‘å™¨...')
            
            try {
                const { data, error } = await supabase
                    .from('information_schema.triggers')
                    .select('trigger_name')
                    .eq('trigger_name', 'trg_simple_lead_allocation')
                
                if (error) {
                    logToArea('all-tests-log', `âŒ æ— æ³•æ£€æŸ¥è§¦å‘å™¨: ${error.message}`)
                } else if (data && data.length > 0) {
                    logToArea('all-tests-log', 'âœ… è§¦å‘å™¨ trg_simple_lead_allocation å­˜åœ¨')
                } else {
                    logToArea('all-tests-log', 'âŒ è§¦å‘å™¨ trg_simple_lead_allocation ä¸å­˜åœ¨')
                }
            } catch (error) {
                logToArea('all-tests-log', `âŒ æ£€æŸ¥è§¦å‘å™¨å¼‚å¸¸: ${error.message}`)
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            testConnection()
        })
    </script>
</body>
</html> 