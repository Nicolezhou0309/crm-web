# 头像压缩配置指南

## 概述

为了提高用户体验和减少存储成本，系统已为头像上传功能配置了自动压缩逻辑，确保上传的头像文件大小不超过500KB。

## 压缩配置

### 默认配置参数

```javascript
compressionOptions: {
  maxSizeMB: 0.5,        // 最大文件大小：500KB
  maxWidthOrHeight: 1024, // 最大宽度或高度：1024px
  useWebWorker: true     // 使用Web Worker进行后台压缩
}
```

### 配置说明

- **maxSizeMB: 0.5** - 限制文件大小不超过500KB
- **maxWidthOrHeight: 1024** - 限制图片最大尺寸为1024px（保持宽高比）
- **useWebWorker: true** - 使用Web Worker进行压缩，避免阻塞主线程

## 影响的组件

### 1. ImageUpload组件 (`src/components/ImageUpload.tsx`)
- 更新了默认压缩配置
- 所有使用此组件的头像上传都会应用500KB限制

### 2. Profile页面 (`src/pages/Profile.tsx`)
- 桌面版个人资料页面的头像上传
- 已更新压缩配置为500KB限制

### 3. MobileProfile页面 (`src/pages/MobileProfile.tsx`)
- 移动端个人资料页面的头像上传
- 已更新压缩配置为500KB限制

## 压缩效果预期

| 原始文件大小 | 预期压缩后大小 | 压缩率 |
|-------------|---------------|--------|
| < 500KB     | 保持原大小    | 0%     |
| 500KB-1MB   | ~400-500KB    | 20-50% |
| 1MB-2MB     | ~400-500KB    | 50-75% |
| > 2MB       | ~400-500KB    | 75%+   |

## 技术实现

### 使用的库
- `browser-image-compression` - 客户端图片压缩库
- `antd-img-crop` - 图片裁剪组件

### 压缩流程
1. 用户选择图片文件
2. 验证文件类型和大小
3. 应用图片压缩（如果启用）
4. 上传到OSS或Supabase Storage
5. 更新用户界面

## 质量保证

### 压缩质量
- 保持原始宽高比
- 优先保持图片清晰度
- 自动选择最佳压缩参数

### 性能优化
- 使用Web Worker避免UI阻塞
- 异步处理压缩任务
- 提供压缩进度反馈

## 测试建议

### 测试用例
1. **小文件测试** - 上传小于500KB的图片，验证不进行压缩
2. **中等文件测试** - 上传1-2MB的图片，验证压缩到500KB以内
3. **大文件测试** - 上传5MB+的图片，验证大幅压缩
4. **格式测试** - 测试JPG、PNG、WebP等不同格式
5. **质量测试** - 验证压缩后图片质量可接受

### 测试工具
使用提供的测试脚本 `test-avatar-compression.js` 进行自动化测试。

## 注意事项

1. **兼容性** - 确保浏览器支持Web Worker
2. **性能** - 大文件压缩可能需要几秒钟时间
3. **质量** - 过度压缩可能影响图片清晰度
4. **存储** - 压缩后的文件会覆盖原始文件

## 故障排除

### 常见问题
1. **压缩失败** - 检查文件格式是否支持
2. **质量过差** - 可以适当调整maxWidthOrHeight参数
3. **上传失败** - 检查网络连接和存储配置

### 调试信息
压缩过程中会在控制台输出详细信息：
- 原始文件大小
- 压缩后文件大小
- 压缩率百分比

## 更新历史

- **2024-01-XX** - 初始配置，设置500KB限制
- **2024-01-XX** - 优化压缩参数，提高图片质量
